<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>金融数据与文献综合分析系统</title>
    <!-- 引入 Bootstrap 与 ECharts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
      body {
        background-color: #f5f7fa;
      }
      .page-title {
        font-weight: 600;
        letter-spacing: 0.08em;
      }
      .chart-card {
        background: #fff;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(15, 35, 52, 0.08);
        height: 360px;
      }
      .chart-box {
        width: 100%;
        height: 100%;
      }
      .section-title {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .summary-box {
        white-space: pre-wrap;
        background: #fff;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid #0d6efd;
        font-size: 0.95rem;
      }
      .sentiment-bar {
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
      }
      .sentiment-seg {
        height: 100%;
      }
      .sentiment-pos {
        background: #4caf50;
      }
      .sentiment-neu {
        background: #ffc107;
      }
      .sentiment-neg {
        background: #f44336;
      }
      /* 分页内容容器：默认隐藏，激活时显示 */
      .section-block {
        display: none;
      }
      .section-block.active {
        display: block;
      }
      /* 左上角随机头像 */
      .corner-avatar {
        position: fixed;
        top: 12px;
        left: 12px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 2px solid #0d6efd;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 9999;
        object-fit: cover;
      }
    </style>
  </head>

  <body>
    <!-- 左上角随机头像 -->
    <img id="cornerAvatar" class="corner-avatar" src="http://api.guiguiya.com/api/img/miyoushe/avatar" alt="avatar" />

    <div class="container-fluid py-3">
      <div class="mb-3 text-center">
        <h2 class="page-title">金融数据与文献综合分析系统</h2>
        <p class="text-muted small mb-1">
          通过前后端交互，对金融数据进行多维度可视化分析，并借助“AI 模型”进行文献摘要与情感分析。
        </p>
        <!-- 原 crawler_ml 独立页面已下线，这里去掉跳转提示 -->
      </div>

      <!-- 布局：左侧侧边栏 + 右侧分页内容 -->
      <div class="row">
        <div class="col-md-2 col-lg-2 mb-3">
          <div class="list-group shadow-sm" id="sideNav">
            <a class="list-group-item list-group-item-action" data-target="section-crawler" href="#">爬虫取数</a>
            <a class="list-group-item list-group-item-action" data-target="section-wordcloud" href="#">词云</a>
            <a class="list-group-item list-group-item-action" data-target="section-sentiment" href="#">金融讯息可视化分析</a>
            <a class="list-group-item list-group-item-action" data-target="section-predict" href="#">股票预测</a>
            <a class="list-group-item list-group-item-action" data-target="section-analysis" href="#">数据分析</a>
          </div>
        </div>

        <!-- 右侧主体内容（分页切换） -->
        <div class="col-md-10 col-lg-10">

        <!-- 爬虫与数据获取 -->
        <div class="card shadow-sm mb-3 section-block" id="section-crawler">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">一、爬虫获取金融新闻并入库</div>
              <small class="text-muted">外网可用时将尝试实时抓取，失败自动回退示例数据</small>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">新闻关键字</label>
                <input id="crawlKeyword" class="form-control" placeholder="例如：利率 / 中概股" />
              </div>
              <div class="col-md-4">
                <label class="form-label">保存到 MySQL 表名</label>
                <input id="crawlTable" class="form-control" value="news_data" />
              </div>
              <div class="col-md-4">
                <button class="btn btn-success w-100" id="crawlBtn">抓取并保存</button>
              </div>
            </div>
            <pre class="bg-dark text-light p-2 small mt-2" style="max-height:180px;overflow:auto" id="crawlPreview"></pre>
          </div>
        </div>

        <!-- 词云 -->
        <div class="card shadow-sm mb-3 section-block" id="section-wordcloud">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">二、词云可视化</div>
              <small class="text-muted">数据源：爬虫表 / 上传 CSV / 文本框</small>
            </div>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">MySQL 表名（可选）</label>
                <input id="wcTable" class="form-control" placeholder="如：news_data" />
              </div>
              <div class="col-md-3">
                <label class="form-label">上传 CSV（第一列为文本）</label>
                <input id="wcFile" type="file" accept=".csv" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">或直接粘贴文本</label>
                <textarea id="wcText" rows="2" class="form-control" placeholder="多段文本可换行"></textarea>
              </div>
            </div>
            <div class="mt-2 d-flex align-items-center gap-2">
              <button class="btn btn-primary" id="wcBtn">生成词云</button>
              <small class="text-muted" id="wcSource"></small>
            </div>
            <div id="wordCloud" style="height:300px" class="mt-2"></div>
          </div>
        </div>

        <!-- 金融讯息可视化分析 -->
        <div class="card shadow-sm mb-3 section-block" id="section-sentiment">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">三、金融讯息可视化分析（TuShare 菁融短讯）</div>
              <small class="text-muted">优先使用菁融短讯接口（jrdc），失败则回退到 news 接口，支持关键词搜索，生成情感分析与词云（后续可扩展更多图表）</small>
            </div>
            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-2">
                <label class="form-label">开始日期</label>
                <input id="flashStartDate" type="datetime-local" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label">结束日期</label>
                <input id="flashEndDate" type="datetime-local" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label">数据源（src）</label>
                <select id="flashSrc" class="form-select">
                  <option value="sina" selected>新浪财经</option>
                  <option value="wallstreetcn">华尔街见闻</option>
                  <option value="10jqka">同花顺</option>
                  <option value="eastmoney">东方财富</option>
                  <option value="yuncaijing">云财经</option>
                  <option value="fenghuang">凤凰新闻</option>
                  <option value="jinrongjie">金融界</option>
                  <option value="cls">财联社</option>
                  <option value="yicai">第一财经</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">关键词搜索</label>
                <input id="flashKeyword" type="text" class="form-control" placeholder="可选，留空则不过滤" />
              </div>
              <div class="col-md-2">
                <label class="form-label">条数（limit）</label>
                <input id="flashLimit" type="number" min="10" max="1500" value="80" class="form-control" />
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" id="flashBtn">拉取菁融短讯</button>
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-md-12 small text-muted" id="flashStatus"></div>
            </div>
            <!-- 短讯原始 JSON 预览（已隐藏） -->
            <pre class="bg-dark text-light p-2 small" style="max-height:160px;overflow:auto;display:none" id="flashPreview"></pre>
            <!-- 每条短讯 + 单条情感得分列表 -->
            <div class="mt-2 small" style="max-height:220px;overflow:auto" id="flashList"></div>
            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <div class="section-title mb-1" style="font-size:0.95rem;">情感分析</div>
                <div class="sentiment-bar mb-1">
                  <div id="flashSentPos" class="sentiment-seg sentiment-pos" style="width:33%"></div>
                  <div id="flashSentNeu" class="sentiment-seg sentiment-neu" style="width:34%"></div>
                  <div id="flashSentNeg" class="sentiment-seg sentiment-neg" style="width:33%"></div>
                </div>
                <div class="small">
                  <span class="text-success">正向：</span><span id="flashSentPosText">-</span>，
                  <span class="text-warning">中性：</span><span id="flashSentNeuText">-</span>，
                  <span class="text-danger">负向：</span><span id="flashSentNegText">-</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="section-title mb-1" style="font-size:0.95rem;">情感比例分布</div>
                <div id="flashSentimentChart" style="height:200px;"></div>
              </div>
              <div class="col-md-8">
                <div class="section-title mb-1" style="font-size:0.95rem;">词云</div>
                <div id="flashWordCloud" style="height:260px"></div>
              </div>
            </div>

            <!-- 额外图表：来源分布 + 文本长度分布 -->
            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.95rem;">来源分布</div>
                <div id="flashSourceChart" style="height:220px;"></div>
              </div>
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.95rem;">文本长度分布</div>
                <div id="flashLenChart" style="height:220px;"></div>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">MySQL 表名（可选）</label>
                <input id="sentTable" class="form-control" placeholder="如：news_data" />
              </div>
              <div class="col-md-3">
                <label class="form-label">上传 CSV</label>
                <input id="sentFile" type="file" accept=".csv" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">粘贴文本</label>
                <textarea id="sentText" rows="2" class="form-control" placeholder="情绪文本，可多行"></textarea>
              </div>
            </div>
            <div class="mt-2">
              <button class="btn btn-warning" id="sentBtn">计算评分</button>
              <span class="text-muted small ms-2" id="sentSource"></span>
            </div>
            <div class="mt-2 small">
              <div>情感：<span id="sentPosText2" class="text-success">-</span> / <span id="sentNeuText2" class="text-secondary">-</span> / <span id="sentNegText2" class="text-danger">-</span></div>
              <div>热度：<span id="sentHeat">-</span>，风险评分：<span id="sentRisk">-</span></div>
            </div>
          </div>
        </div>

        <!-- 股票预测 / TuShare 多指数 -->
        <div class="card shadow-sm mb-3 section-block" id="section-predict">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">四、TuShare 多指数行情</div>
              <small class="text-muted">拉取上证/深成/创业/沪深300/中证500 等指数，自动绘制多折线</small>
            </div>

            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-4">
                <button class="btn btn-success w-100" id="tsBtn">拉取 TuShare 指数行情</button>
              </div>
            </div>

            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">多指数走势</div>
                <div id="predictChart" style="height:320px"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">最新报价</div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0" id="tsTable">
                    <thead>
                      <tr>
                        <th>指数</th>
                        <th>最新价</th>
                        <th>涨跌幅</th>
                        <th>日期</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 货币板块 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="section-title mb-0" style="font-size: 0.95rem;">货币（相对人民币）</div>
                  <button class="btn btn-outline-secondary btn-sm" id="fxBtn">刷新货币报价</button>
                </div>
                <div class="table-responsive mb-2">
                  <table class="table table-sm table-striped mb-0" id="fxTable">
                    <thead>
                      <tr>
                        <th>货币</th>
                        <th>符号</th>
                        <th>价格</th>
                        <th>涨跌额</th>
                        <th>涨跌幅</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="small text-muted mb-1">
                  提示：点击上表中的“美元/人民币、英镑/人民币、日元/人民币”任意一行，可查看近期走势折线图。
                </div>
                <div id="fxChart" style="height:260px;"></div>
              </div>
            </div>

            <!-- 单只股票区间涨幅 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">单只股票区间涨幅分析</div>
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">股票代码（ts_code）</label>
                    <input id="stockCode" class="form-control" placeholder="如：600519.SH" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">开始日期</label>
                    <input id="stockStart" class="form-control" placeholder="如：20250101" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">结束日期</label>
                    <input id="stockEnd" class="form-control" placeholder="如：20251231" />
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="stockBtn">查询涨幅</button>
                  </div>
                </div>
                <div id="stockChart" style="height:260px" class="mt-2"></div>
              </div>
            </div>

            <!-- 统一预测面板：指数 / 股票 / 通用 ML -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size:0.95rem;">机器学习与时间序列预测</div>

                <!-- 预测类型切换 -->
                <div class="mb-2">
                  <label class="form-label me-2">预测类型：</label>
                  <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeIndex" value="index" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="mlModeIndex">指数预测</label>
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeStock" value="stock" autocomplete="off">
                    <label class="btn btn-outline-primary" for="mlModeStock">股票预测</label>
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeGeneric" value="generic" autocomplete="off">
                    <label class="btn btn-outline-primary" for="mlModeGeneric">通用 ML</label>
                  </div>
                </div>

                <!-- 指数预测表单 -->
                <div id="mlPanelIndex" class="mb-2">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">选择指数</label>
                      <select id="indexPredCode" class="form-select">
                        <option value="000001.SH">上证指数 (000001.SH)</option>
                        <option value="399001.SZ">深证成指 (399001.SZ)</option>
                        <option value="399006.SZ">创业板指 (399006.SZ)</option>
                        <option value="000300.SH">沪深300 (000300.SH)</option>
                        <option value="000905.SH">中证500 (000905.SH)</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="indexPredHorizon" type="number" min="3" max="60" value="8" class="form-control" />
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-outline-info w-100" id="indexPredBtn">生成指数预测</button>
                    </div>
                  </div>
                </div>

                <!-- 股票预测表单 -->
                <div id="mlPanelStock" class="mb-2" style="display:none;">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">股票代码（ts_code）</label>
                      <input id="stockPredCode" class="form-control" placeholder="如：600519.SH" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="stockPredHorizon" type="number" min="3" max="60" value="8" class="form-control" />
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-outline-success w-100" id="stockPredBtn">生成股票预测</button>
                    </div>
                  </div>
                </div>

                <!-- 通用 ML 表单 -->
                <div id="mlPanelGeneric" class="mb-2" style="display:none;">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                      <label class="form-label">选择表（仅展示可用于预测的表）</label>
                      <select id="mlTable" class="form-select"></select>
                    </div>
                    <div class="col-md-5">
                      <label class="form-label">特征列（可多选，按 Ctrl/Shift 选择）</label>
                      <select id="mlFeatures" class="form-select" multiple size="4"></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">目标列（可选）</label>
                      <select id="mlTarget" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="mlHorizon" type="number" min="0" max="60" value="0" class="form-control" />
                    </div>
                    <div class="col-md-2 mt-2">
                      <button class="btn btn-outline-primary w-100" id="mlBtn">运行 ML 模型</button>
                    </div>
                  </div>
                  <div class="small text-muted mt-1">
                    说明：仅展示外汇等可用于时间序列/价格预测的表；若目标列为空，则只运行聚类；若指定目标列且存在，则同时运行回归与分类。
                  </div>
                  <pre id="mlResult" class="bg-dark text-light p-2 small mt-2" style="max-height:180px;overflow:auto;"></pre>
                </div>

                <!-- 通用 ML 指标图表（仅通用 ML 模式下使用） -->
                <div id="mlGenericCharts">
                  <div class="row g-2 mt-2">
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">回归指标</div>
                          <div id="mlChartReg" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">分类指标</div>
                          <div id="mlChartCls" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">聚类指标</div>
                          <div id="mlChartClu" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 统一时间序列 / 指数 / 股票预测曲线 -->
                <div class="card mt-2">
                  <div class="card-body p-2">
                    <div class="section-title mb-1" style="font-size:0.95rem;">时间序列与预测</div>
                    <div id="mlTsChart" style="height:260px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!-- 数据分析分页容器 -->
      <div class="section-block" id="section-analysis">
      <!-- 输入区域：数据与文本 -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">一、金融数据输入</div>
              <div class="mb-2 small text-muted">
                支持三种方式：1）上传 CSV 文件；2）在下方文本框粘贴表格数据；3）使用示例内置数据集。
              </div>

              <div class="mb-3">
                <label class="form-label">1）上传 CSV 文件</label>
                <input
                  type="file"
                  class="form-control"
                  id="fileInput"
                  accept=".csv"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">2）粘贴 CSV 文本</label>
                <textarea
                  class="form-control"
                  id="textData"
                  rows="4"
                  placeholder="在此粘贴以逗号分隔的表格数据（首行为列名）"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">3）使用内置示例数据集</label>
                <select class="form-select" id="datasetSelect">
                  <option value="ads" selected>广告投放与销售数据（advertising.csv）</option>
                  <option value="trade">股票交易数据（trade.csv）</option>
                </select>
              </div>

              <div class="row g-2">
                <div class="col">
                  <label class="form-label">X 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="xCol"
                    placeholder="例如：TV / Open"
                  />
                </div>
                <div class="col">
                  <label class="form-label">Y 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="yCol"
                    placeholder="例如：Sales / Close"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <div class="section-title">二、金融文献 / 新闻文本</div>
              <div class="mb-2 small text-muted">
                将金融研究报告、新闻或公告粘贴在此，系统将调用“AI 模型”生成摘要并进行情感分析（示例实现）。
              </div>
              <textarea
                class="form-control mb-3 flex-grow-1"
                id="docText"
                rows="6"
                placeholder="在此粘贴金融文本，例如一段关于某只股票的研究报告或市场新闻……"
              ></textarea>

              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" id="analyzeBtn">
                  开始分析
                </button>
                <span class="small text-muted" id="statusText"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 数值分析与 AI 文本分析结果 -->
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">
                三、数值分析摘要
                <small class="text-muted" id="xyLabel"></small>
              </div>
              <div id="summaryBox" class="summary-box small">
                点击“开始分析”后，这里将展示基于金融数据的简要分析结论。
              </div>
              <div class="mt-2 small text-muted" id="savedFiles"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="section-title">四、AI 文本摘要与情感分析</div>
              <div
                id="aiSummary"
                class="summary-box small mb-2"
                style="min-height: 80px"
              >
                若输入了金融文本，这里将给出“AI 模型”生成的摘要示例。
              </div>
              <div class="small text-muted mb-1">情感分布：</div>
              <div class="sentiment-bar mb-1">
                <div
                  id="sentPos"
                  class="sentiment-seg sentiment-pos"
                  style="width: 33%"
                ></div>
                <div
                  id="sentNeu"
                  class="sentiment-seg sentiment-neu"
                  style="width: 34%"
                ></div>
                <div
                  id="sentNeg"
                  class="sentiment-seg sentiment-neg"
                  style="width: 33%"
                ></div>
              </div>
              <div class="small">
                <span class="text-success">正向：</span
                ><span id="sentPosText">33%</span>，
                <span class="text-warning">中性：</span
                ><span id="sentNeuText">34%</span>，
                <span class="text-danger">负向：</span
                ><span id="sentNegText">33%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 五类及以上图形展示 -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="section-title mb-2">五、多维度图形可视化（不少于 5 类）</div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartLine" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">折线图：收益趋势</div>
            </div>
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartBar" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">柱状图：收益对比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartPie" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">饼图：收益区间占比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartScatter" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">散点图：单期收益散点分布</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartBox" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">箱线图：整体收益分布</div>
            </div>
          </div>
        </div>
      </div>

        </div> <!-- /section-analysis -->
        </div> <!-- /右侧主体 -->
      </div> <!-- /row -->

      <footer class="text-center text-muted small py-2">
        课程实验示例 &copy; 金融数据分析与 AI 应用
      </footer>
    </div>

    <script>
      // 初始化图表实例
      const chartLine = echarts.init(document.getElementById("chartLine"));
      const chartBar = echarts.init(document.getElementById("chartBar"));
      const chartPie = echarts.init(document.getElementById("chartPie"));
      const chartScatter = echarts.init(document.getElementById("chartScatter"));
      const chartBox = echarts.init(document.getElementById("chartBox"));
      const wordChart = echarts.init(document.getElementById("wordCloud"));
      const flashWordChart = echarts.init(document.getElementById("flashWordCloud"));
      const flashSourceChart = echarts.init(document.getElementById("flashSourceChart"));
      const flashLenChart = echarts.init(document.getElementById("flashLenChart"));
      const flashSentimentChart = echarts.init(document.getElementById("flashSentimentChart"));
      const predictChart = echarts.init(document.getElementById("predictChart"));

      // 外汇折线图：页面初始时可能处于隐藏分页，直接 init 会导致 0 宽高渲染失败
      function getFxChart() {
        const dom = document.getElementById("fxChart");
        if (!dom) return null;
        let inst = echarts.getInstanceByDom(dom);
        if (!inst) inst = echarts.init(dom);
        return inst;
      }

      // 侧边栏分页切换
      const sectionBlocks = document.querySelectorAll(".section-block");
      const sideLinks = document.querySelectorAll("#sideNav a[data-target]");
      let predictLoaded = false;

      function showSection(id) {
        sectionBlocks.forEach((sec) => {
          sec.classList.toggle("active", sec.id === id);
        });
        sideLinks.forEach((link) => {
          link.classList.toggle("active", link.dataset.target === id);
        });

        // 首次切换到“股票预测”分页时自动获取指数与货币数据 + 加载 ML 表结构
        if (id === "section-predict" && !predictLoaded) {
          if (typeof loadTsMarket === "function") {
            loadTsMarket();
          }
          if (typeof loadFx === "function") {
            loadFx();
          }
          if (typeof loadMlSchema === "function") {
            loadMlSchema();
          }
          predictLoaded = true;
        }

        // 切换到股票预测分页后，强制 resize 所有图表，避免图表容器初始宽高为 0
        if (id === "section-predict") {
          setTimeout(() => {
            if (predictChart) predictChart.resize();
            const c = getFxChart();
            if (c) c.resize();
            // 股票区间图表
            const stockDom = document.getElementById("stockChart");
            if (stockDom) {
              const stockInst = echarts.getInstanceByDom(stockDom);
              if (stockInst) stockInst.resize();
            }
          }, 50);
        }
      }

      sideLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          showSection(this.dataset.target);
        });
      });

      // 默认显示第一个分页
      if (sideLinks.length > 0) {
        showSection(sideLinks[0].dataset.target);
      }

      // 简单 HTML 转义，避免标题中出现标签时影响页面
      function htmlEscape(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // 渲染 ML 指标条形图
      function renderMlMetrics(domId, metrics, title = "") {
        const dom = document.getElementById(domId);
        if (!dom) return;
        let chart = echarts.getInstanceByDom(dom);
        if (!chart) chart = echarts.init(dom);

        const entries = Object.entries(metrics || {}).filter(
          ([, v]) => typeof v === "number" && isFinite(v)
        );

        if (entries.length === 0) {
          chart.setOption({
            title: { text: title || "无可用指标", left: "center", textStyle: { fontSize: 12 } },
            xAxis: { show: false }, yAxis: { show: false }, series: [],
          });
          return;
        }

        const names = entries.map(([k]) => k);
        const values = entries.map(([, v]) => v);

        chart.setOption({
          title: { text: title, left: "center", textStyle: { fontSize: 12 } },
          tooltip: { trigger: "axis" },
          grid: { left: 60, right: 20, top: 30, bottom: 20 },
          xAxis: { type: "value" },
          yAxis: { type: "category", data: names },
          series: [
            { type: "bar", data: values, itemStyle: { color: "#0d6efd" } },
          ],
        });
      }

      // 渲染 ML 时间序列预测
      function renderMlForecast(ts) {
        const dom = document.getElementById("mlTsChart");
        if (!dom) return;
        let chart = echarts.getInstanceByDom(dom);
        if (!chart) chart = echarts.init(dom);

        if (!ts || !Array.isArray(ts.history) || ts.history.length === 0) {
          chart.setOption({
            title: { text: "暂无时间序列数据", left: "center", textStyle: { fontSize: 12 } },
            xAxis: { show: false }, yAxis: { show: false }, series: [],
          });
          return;
        }

        const fullHist = ts.history || [];
        const fut = ts.forecast || [];

        // 为了保证右侧的“预测部分”始终清晰可见，如果点太多，只展示
        // “最近一段历史 + 全部预测”，从右往左回看。
        const MAX_POINTS = 80; // 视图中最多展示的总点数（历史 + 预测）
        let hist = fullHist;
        if (fullHist.length + fut.length > MAX_POINTS) {
          const keepHist = Math.max(10, MAX_POINTS - fut.length); // 至少保留一些历史
          hist = fullHist.slice(-keepHist);
        }

        // 横坐标优先使用日期（date），否则退回到 x 或索引
        const histLabels = hist.map((p, idx) => p.date ?? p.x ?? idx);
        const futLabels = fut.map(
          (p, idx) => p.date ?? `t+${idx + 1}`
        );

        const xs = histLabels.concat(futLabels);
        const ysHist = hist.map((p) => p.y);
        const ysFut = new Array(histLabels.length)
          .fill(null)
          .concat(fut.map((p) => p.y));

        chart.setOption({
          title: {
            text: `目标列 ${ts.target_col || ""} 的历史与预测`,
            left: "center",
            textStyle: { fontSize: 12 },
          },
          tooltip: { trigger: "axis" },
          legend: { top: 20, data: ["历史", "预测"] },
          grid: { left: 60, right: 20, top: 50, bottom: 30 },
          xAxis: { type: "category", data: xs, name: "时间" },
          yAxis: { type: "value", name: "数值" },
          series: [
            {
              name: "历史",
              type: "line",
              smooth: true,
              data: ysHist,
            },
            {
              name: "预测",
              type: "line",
              smooth: true,
              data: ysFut,
            },
          ],
        });
      }

      // 设置空白初始配置
      chartLine.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBar.setOption({ title: { text: "等待数据...", left: "center" } });
      chartPie.setOption({ title: { text: "等待数据...", left: "center" } });
      chartScatter.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBox.setOption({ title: { text: "等待数据...", left: "center" } });
      wordChart.setOption({ title: { text: "等待数据...", left: "center" } });
      predictChart.setOption({ title: { text: "等待数据...", left: "center" } });
      flashSourceChart.setOption({ title: { text: "等待数据...", left: "center" } });
      flashLenChart.setOption({ title: { text: "等待数据...", left: "center" } });
      flashSentimentChart.setOption({ 
        title: { text: "等待数据...", left: "center" },
        legend: { show: false },
        series: []
      });

      // 加载 ML 可选表与列
      function loadMlSchema() {
        fetch("/api/ml_schema")
          .then((r) => r.json())
          .then((d) => {
            if (d.status === "error") throw new Error(d.msg || "加载失败");
            const tables = d.tables || [];
            const tableSel = document.getElementById("mlTable");
            const featSel = document.getElementById("mlFeatures");
            const targetSel = document.getElementById("mlTarget");
            if (!tableSel || !featSel || !targetSel) return;

            tableSel.innerHTML = "";
            tables.forEach((t, idx) => {
              const opt = document.createElement("option");
              opt.value = t.name;
              opt.textContent = t.label || t.name;
              if (idx === 0) opt.selected = true;
              tableSel.appendChild(opt);
            });

            function updateCols() {
              const current = tableSel.value;
              const info = tables.find((t) => t.name === current);
              const cols = (info && info.columns) || [];
              featSel.innerHTML = "";
              targetSel.innerHTML = "";
              cols.forEach((c) => {
                const opt1 = document.createElement("option");
                opt1.value = c;
                opt1.textContent = c;
                featSel.appendChild(opt1);

                const opt2 = document.createElement("option");
                opt2.value = c;
                opt2.textContent = c;
                targetSel.appendChild(opt2);
              });
              // 默认：特征列全部不选，由用户手动选择；目标列默认选最后一列
              if (targetSel.options.length > 0) {
                targetSel.options[targetSel.options.length - 1].selected = true;
              }
            }

            tableSel.addEventListener("change", updateCols);
            updateCols();
          })
          .catch((e) => {
            const box = document.getElementById("mlResult");
            if (box) box.textContent = "ML 表结构加载失败：" + e.message;
          });
      }

      /**
       * 辅助函数：更新情感条与文本
       */
      function updateSentimentBar(sentiment) {
        const p = Math.round((sentiment.positive || 0) * 100);
        const n = Math.round((sentiment.neutral || 0) * 100);
        const g = Math.round((sentiment.negative || 0) * 100);
        document.getElementById("sentPos").style.width = p + "%";
        document.getElementById("sentNeu").style.width = n + "%";
        document.getElementById("sentNeg").style.width = g + "%";
        document.getElementById("sentPosText").innerText = p + "%";
        document.getElementById("sentNeuText").innerText = n + "%";
        document.getElementById("sentNegText").innerText = g + "%";
      }

      /**
       * 菁融短讯：渲染“每条短讯 + 单条情感得分”列表
       */
      function renderFlashList(items) {
        const box = document.getElementById("flashList");
        if (!box) return;
        box.innerHTML = "";
        (items || []).forEach((it, idx) => {
          const s = it.sentiment || {};
          // 计算综合得分：正向接近1，中性接近0.6，负向接近0
          const p = s.positive !== undefined ? s.positive : 0;
          const n = s.neutral !== undefined ? s.neutral : 0;
          const g = s.negative !== undefined ? s.negative : 0;
          
          // 综合得分公式：正向*1.0 + 中性*0.6 + 负向*0.0
          const compositeScore = p * 1.0 + n * 0.6 + g * 0.0;
          
          // 根据得分确定颜色
          let scoreClass = "text-warning"; // 默认中性（黄色）
          if (compositeScore >= 0.7) {
            scoreClass = "text-success"; // 正向（绿色）
          } else if (compositeScore <= 0.3) {
            scoreClass = "text-danger"; // 负向（红色）
          }
          
          const t = it.pub_time || it.datetime || "";
          const title = it.title || "(无标题)";
          const src = it.src || "";
          const url = it.url || "";
          const div = document.createElement("div");
          div.className = "mb-1";
          const titleHtml = url
            ? `<a href="${htmlEscape(url)}" target="_blank" rel="noopener" class="text-primary">${htmlEscape(title)}</a>`
            : `<span class="text-primary">${htmlEscape(title)}</span>`;
          div.innerHTML =
            `<span class="text-muted">${idx + 1}.</span> ` +
            (t ? `[${htmlEscape(t)}] ` : "") +
            titleHtml +
            (src ? ` <span class="text-muted">(${htmlEscape(src)})</span>` : "") +
            ` <span class="ms-1 ${scoreClass}">得分:${compositeScore}</span>`;
          box.appendChild(div);
        });
      }

      /**
       * 辅助函数：根据后端返回数据更新所有图表
       */
      function updateCharts(payload) {
        const charts = payload.charts || {};
        const x = charts.line?.x || [];
        const y = charts.line?.y || [];

        // 折线图
        chartLine.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: x },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: y,
            },
          ],
        });

        // 柱状图
        chartBar.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: charts.bar?.x || [] },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "bar",
              data: charts.bar?.y || [],
              itemStyle: { color: "#0d6efd" },
            },
          ],
        });

        // 饼图
        chartPie.setOption({
          tooltip: { trigger: "item" },
          legend: { top: "bottom" },
          series: [
            {
              name: "收益区间",
              type: "pie",
              radius: "65%",
              data: charts.pie || [],
            },
          ],
        });

        // 散点图
        const scatterX = charts.scatter?.x || [];
        const scatterY = charts.scatter?.y || [];
        const scatterData = scatterX.map((v, i) => [v, scatterY[i]]);
        chartScatter.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "value", name: "期数" },
          yAxis: { type: "value", name: payload.y_col },
          series: [
            {
              name: "单期收益",
              type: "scatter",
              symbolSize: 8,
              data: scatterData,
            },
          ],
        });

        // 箱线图
        const box = charts.boxplot?.data || [];
        chartBox.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "category", data: [payload.y_col] },
          yAxis: { type: "value" },
          series: [
            {
              name: "收益分布",
              type: "boxplot",
              data: [box],
            },
          ],
        });
      }

      /**
       * 词云渲染
       */
      function renderWordCloud(words) {
        wordChart.setOption({
          tooltip: {},
          series: [
            {
              type: "wordCloud",
              shape: "circle",
              sizeRange: [12, 42],
              rotationRange: [-45, 45],
              gridSize: 6,
              textStyle: {
                color: () =>
                  "rgb(" +
                  [
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                  ].join(",") +
                  ")",
              },
              data: words,
            },
          ],
        });
      }

      function renderFlashWordCloud(words) {
        flashWordChart.setOption({
          tooltip: {},
          series: [
            {
              type: "wordCloud",
              shape: "circle",
              gridSize: 6,
              sizeRange: [10, 44],
              rotationRange: [-30, 30],
              textStyle: {
                color: function () {
                  const colors = ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272"];
                  return colors[Math.floor(Math.random() * colors.length)];
                },
              },
              data: words,
            },
          ],
        });
      }

      // 金融讯息：来源分布图（饼图）
      function renderFlashSourceChart(stats) {
        const data = stats || [];
        const hasData = Array.isArray(data) && data.length > 0;
        if (!hasData) {
          flashSourceChart.setOption({
            title: { text: "来源分布（暂无数据）", left: "center", textStyle: { fontSize: 12 } },
            series: [],
          });
          return;
        }
        flashSourceChart.setOption({
          tooltip: { trigger: "item" },
          legend: { top: 10, left: "center" },
          series: [
            {
              type: "pie",
              radius: "65%",
              data,
              label: { formatter: "{b}: {c}" },
            },
          ],
        });
      }

      // 金融讯息：文本长度分布（柱状图）
      function renderFlashLenChart(buckets) {
        const data = buckets || [];
        const hasData = Array.isArray(data) && data.length > 0;
        if (!hasData) {
          flashLenChart.setOption({
            title: { text: "文本长度分布（暂无数据）", left: "center", textStyle: { fontSize: 12 } },
            xAxis: { show: false },
            yAxis: { show: false },
            series: [],
          });
          return;
        }
        const names = data.map((d) => d.name);
        const values = data.map((d) => d.value);
        flashLenChart.setOption({
          tooltip: { trigger: "axis" },
          grid: { left: 40, right: 20, top: 30, bottom: 30 },
          xAxis: { type: "category", data: names },
          yAxis: { type: "value" },
          series: [
            {
              type: "bar",
              data: values,
              itemStyle: { color: "#0d6efd" },
            },
          ],
        });
      }

      // 金融讯息：情感比例分布（饼图）
      function renderFlashSentimentChart(items) {
        if (!items || items.length === 0) {
          flashSentimentChart.setOption({
            title: { text: "情感比例分布（暂无数据）", left: "center", textStyle: { fontSize: 12 } },
            legend: { show: false },
            series: [],
          });
          return;
        }

        // 计算所有新闻的情感平均值
        let totalPos = 0;
        let totalNeu = 0;
        let totalNeg = 0;
        let count = 0;

        items.forEach((it) => {
          const s = it.sentiment || {};
          if (s.positive !== undefined || s.neutral !== undefined || s.negative !== undefined) {
            totalPos += s.positive || 0;
            totalNeu += s.neutral || 0;
            totalNeg += s.negative || 0;
            count++;
          }
        });

        if (count === 0) {
          flashSentimentChart.setOption({
            title: { text: "情感比例分布（暂无数据）", left: "center", textStyle: { fontSize: 12 } },
            legend: { show: false },
            series: [],
          });
          return;
        }

        // 计算平均值并转换为百分比
        const avgPos = (totalPos / count) * 100;
        const avgNeu = (totalNeu / count) * 100;
        const avgNeg = (totalNeg / count) * 100;

        const data = [
          { value: avgPos, name: "正向", itemStyle: { color: "#28a745" } },
          { value: avgNeu, name: "中性", itemStyle: { color: "#ffc107" } },
          { value: avgNeg, name: "负向", itemStyle: { color: "#dc3545" } },
        ];

        flashSentimentChart.setOption({
          tooltip: {
            trigger: "item",
            formatter: "{b}: {c}% ({d}%)",
          },
          legend: {
            top: 10,
            left: "right",  // 改为右对齐，布局往右一点
            orient: "vertical",  // 垂直排列
          },
          series: [
            {
              type: "pie",
              radius: "65%",
              center: ["40%", "55%"],  // 饼图稍微往左移，为右侧legend留空间
              data: data,
              label: {
                formatter: "{b}: {c}%",
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: "rgba(0, 0, 0, 0.5)",
                },
              },
            },
          ],
        });
      }

      function updateFlashSentimentBar(sentiment) {
        const s = sentiment || {};
        const p = Math.max(0, Math.min(1, s.positive ?? 0.33));
        const n = Math.max(0, Math.min(1, s.neutral ?? 0.34));
        const g = Math.max(0, Math.min(1, s.negative ?? 0.33));
        document.getElementById("flashSentPos").style.width = `${Math.round(p * 100)}%`;
        document.getElementById("flashSentNeu").style.width = `${Math.round(n * 100)}%`;
        document.getElementById("flashSentNeg").style.width = `${Math.round(g * 100)}%`;
        document.getElementById("flashSentPosText").innerText = `${Math.round(p * 100)}%`;
        document.getElementById("flashSentNeuText").innerText = `${Math.round(n * 100)}%`;
        document.getElementById("flashSentNegText").innerText = `${Math.round(g * 100)}%`;
      }

      /**
       * 股票预测渲染
       */
      function renderPredict(history, forecast, yCol) {
        const histData = history.map((d) => [d.x, d.y]);
        const futData = forecast.map((d) => [d.x, d.y]);
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "value" },
          yAxis: { type: "value", name: yCol || "price" },
          series: [
            {
              name: "历史",
              type: "line",
              data: histData,
              smooth: true,
              symbol: "circle",
            },
            {
              name: "预测",
              type: "line",
              data: futData,
              smooth: true,
              lineStyle: { type: "dashed" },
              symbol: "triangle",
            },
          ],
        });
      }

      /**
       * TuShare 指数行情渲染
       */
      function renderTsMarket(data) {
        const x = (data.x || []).map((d) => d);
        const series = data.series || [];
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          legend: {
            top: 10,
            type: "scroll", // 当图例较多时可横向滚动
            orient: "horizontal",
            itemGap: 18,
            textStyle: {
              fontSize: 12,
            },
          },
          xAxis: {
            type: "category",
            data: x,
          },
          yAxis: { type: "value", name: "指数点位" },
          series,
        });

        // 填充表格
        const tbody = document.querySelector("#tsTable tbody");
        tbody.innerHTML = "";
        (data.latest || []).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}%</td>
            <td>${row.date}</td>
          `;
          tbody.appendChild(tr);
        });

        // 如果存在缺失的指数，给出提示
        if (data.missing && data.missing.length > 0) {
          const msg = "以下指数未能从 TuShare 拉取，使用占位数据：" + data.missing.join("、");
          predictChart.setOption({
            title: { text: msg, left: "center", textStyle: { fontSize: 12 } },
          });
        } else {
          predictChart.setOption({ title: { text: "" } });
        }
      }

      /**
       * 货币表渲染
       */
      function renderFxTable(data) {
        const tbody = document.querySelector("#fxTable tbody");
        tbody.innerHTML = "";
        (data.currencies || []).forEach((row) => {
          const tr = document.createElement("tr");
          if (row.pair) {
            tr.dataset.pair = row.pair;
            tr.dataset.name = row.name || "";
            tr.style.cursor = "pointer";
            tr.title = "点击查看近期走势";
          }
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.symbol}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}</td>
            <td class="${row.pct >= 0 ? "text-success" : "text-danger"}">${row.pct}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      /**
       * 加载单个货币对的近期走势（相对人民币）
       */
      function loadFxHistory(pair, name) {
        const days = 60; // 默认查看近 60 天
        fetch(`/api/fx_history?pair=${encodeURIComponent(pair)}&days=${days}`)
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            const dates = d.dates || [];
            const closes = d.closes || [];
            const fxChart = getFxChart();
            if (!fxChart) return;

            // y 轴区间：默认按数据自适应并加边距；USDCNY 可按 8~10 展示
            let yMin = null;
            let yMax = null;
            const nums = (closes || []).map((v) => Number(v)).filter((v) => Number.isFinite(v));
            if (nums.length > 0) {
              const minV = Math.min(...nums);
              const maxV = Math.max(...nums);
              const span = Math.max(1e-9, maxV - minV);
              const pad = span * 0.08; // 8% 边距
              yMin = minV - pad;
              yMax = maxV + pad;
            }

            // 美元/人民币：优先用 7~8 的可读区间，但不截断真实数据
            if (pair === "USDCNY") {
              const preferMin = 7;
              const preferMax = 8;
              if (yMin == null || yMax == null) {
                yMin = preferMin;
                yMax = preferMax;
              } else {
                yMin = Math.min(yMin, preferMin);
                yMax = Math.max(yMax, preferMax);
              }
            }

            fxChart.setOption({
              tooltip: { trigger: "axis" },
              title: {
                text: `${d.name || name} 近期走势（相对人民币）`,
                left: "center",
                textStyle: { fontSize: 12 },
              },
              xAxis: { type: "category", data: dates },
              yAxis: { type: "value", name: "汇率", min: yMin, max: yMax },
              series: [
                {
                  name: d.symbol || pair,
                  type: "line",
                  smooth: true,
                  data: closes,
                },
              ],
            });
            // 确保在可见尺寸下渲染
            setTimeout(() => fxChart.resize(), 0);
          })
          .catch((e) => {
            alert("货币历史数据拉取失败：" + e.message);
          });
      }

      // 货币表：使用事件委托，避免重复绑定或渲染后丢失事件
      const fxTbody = document.querySelector("#fxTable tbody");
      if (fxTbody) {
        fxTbody.addEventListener("click", (ev) => {
          const tr = ev.target && ev.target.closest ? ev.target.closest("tr") : null;
          if (!tr) return;
          const pair = tr.dataset.pair;
          if (!pair) return;
          loadFxHistory(pair, tr.dataset.name || pair);
        });
      }

      /**
       * 单股区间涨幅图渲染
       */
      function renderStockRange(dates, cumChange, code) {
        const dom = document.getElementById("stockChart");
        const stockChart = echarts.init(dom);
        stockChart.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: dates },
          yAxis: { type: "value", name: "累计涨幅(%)" },
          series: [
            {
              name: code,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: cumChange,
            },
          ],
        });
      }

      /**
       * 点击“开始分析”按钮时，将表单数据打包并通过 fetch 提交给后端
       */

      // 爬虫按钮
      document.getElementById("crawlBtn").addEventListener("click", function () {
        const fd = new FormData();
        fd.append("keyword", document.getElementById("crawlKeyword").value);
        fd.append("table_name", document.getElementById("crawlTable").value);
        fetch("/api/crawl_news_v2", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("crawlPreview").textContent = JSON.stringify(
              d,
              null,
              2
            );
          })
          .catch((e) => {
            document.getElementById("crawlPreview").textContent =
              "请求失败：" + e;
          });
      });

      // 词云
      document.getElementById("wcBtn").addEventListener("click", function () {
        const fd = new FormData();
        const file = document.getElementById("wcFile").files[0];
        if (file) fd.append("file", file);
        fd.append("text_data", document.getElementById("wcText").value);
        fd.append("table_name", document.getElementById("wcTable").value);
        fetch("/api/wordcloud", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("wcSource").innerText =
              "数据源：" + (d.source || "未知");
            renderWordCloud(d.words || []);
          })
          .catch((e) => {
            document.getElementById("wcSource").innerText = "请求失败：" + e;
          });
      });

      // 评分系统
      document.getElementById("sentBtn").addEventListener("click", function () {
        const fd = new FormData();
        const file = document.getElementById("sentFile").files[0];
        if (file) fd.append("file", file);
        fd.append("text_data", document.getElementById("sentText").value);
        fd.append("table_name", document.getElementById("sentTable").value);
        fetch("/api/sentiment_score", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("sentSource").innerText =
              "数据源：" + (d.source || "未知");
            const s = d.sentiment || {};
            const p = Math.round((s.positive || 0) * 100);
            const n = Math.round((s.neutral || 0) * 100);
            const g = Math.round((s.negative || 0) * 100);
            document.getElementById("sentPosText2").innerText = `正向 ${p}%`;
            document.getElementById("sentNeuText2").innerText = `中性 ${n}%`;
            document.getElementById("sentNegText2").innerText = `负向 ${g}%`;
            document.getElementById("sentHeat").innerText = `热度 ${(d.heat || 0).toFixed(2)}`;
            document.getElementById("sentRisk").innerText = d.risk ?? "-";
            // 同时更新顶部情感条便于复用
            updateSentimentBar(s);
          })
          .catch((e) => {
            document.getElementById("sentSource").innerText = "请求失败：" + e;
          });
      });

      // MySQL 机器学习预测（回归 / 分类 / 聚类）
      const mlBtn = document.getElementById("mlBtn");
      if (mlBtn) {
        mlBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "运行中...";

          const tableSel = document.getElementById("mlTable");
          const featSel = document.getElementById("mlFeatures");
          const targetSel = document.getElementById("mlTarget");
          const horizonInput = document.getElementById("mlHorizon");

          const tableName = tableSel ? tableSel.value : "";
          const featureCols = featSel
            ? Array.from(featSel.selectedOptions).map((o) => o.value)
            : [];
          const targetCol = targetSel ? (targetSel.value || "") : "";
          const horizon = horizonInput ? Number(horizonInput.value || 0) : 0;

          const fd = new FormData();
          fd.append("table_name", tableName || "financial_series");
          fd.append("feature_cols", featureCols.join(","));
          fd.append("target_col", targetCol);
          fd.append("horizon", String(horizon));

          fetch("/api/run_ml", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              const box = document.getElementById("mlResult");
              box.textContent = JSON.stringify(d, null, 2);

              const models = d.models || {};
              // 回归
              if (models.regression && !models.regression.error) {
                renderMlMetrics("mlChartReg", models.regression.metrics || {}, "回归指标");
              } else {
                renderMlMetrics("mlChartReg", {}, "回归指标");
              }
              // 分类
              if (models.classification && !models.classification.error) {
                renderMlMetrics("mlChartCls", models.classification.metrics || {}, "分类指标");
              } else {
                renderMlMetrics("mlChartCls", {}, "分类指标");
              }
              // 聚类
              if (models.clustering && !models.clustering.error) {
                renderMlMetrics("mlChartClu", models.clustering.metrics || {}, "聚类指标");
              } else {
                renderMlMetrics("mlChartClu", {}, "聚类指标");
              }

              // 时间序列预测（若后端返回）
              if (d.ts_forecast) {
                renderMlForecast(d.ts_forecast);
              } else {
                renderMlForecast(null);
              }
            })
            .catch((e) => {
              const box = document.getElementById("mlResult");
              box.textContent = "请求失败：" + e;
              renderMlMetrics("mlChartReg", {}, "回归指标");
              renderMlMetrics("mlChartCls", {}, "分类指标");
              renderMlMetrics("mlChartClu", {}, "聚类指标");
              renderMlForecast(null);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 预测类型切换：指数 / 股票 / 通用 ML
      function switchMlMode(mode) {
        const panelIndex = document.getElementById("mlPanelIndex");
        const panelStock = document.getElementById("mlPanelStock");
        const panelGeneric = document.getElementById("mlPanelGeneric");
        const genericCharts = document.getElementById("mlGenericCharts");

        if (!panelIndex || !panelStock || !panelGeneric || !genericCharts) return;

        panelIndex.style.display = mode === "index" ? "" : "none";
        panelStock.style.display = mode === "stock" ? "" : "none";
        panelGeneric.style.display = mode === "generic" ? "" : "none";

        // 通用 ML 指标图表只在 generic 模式下显示
        genericCharts.style.display = mode === "generic" ? "" : "none";
      }

      document.getElementById("mlModeIndex")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("index");
      });
      document.getElementById("mlModeStock")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("stock");
      });
      document.getElementById("mlModeGeneric")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("generic");
      });

      // 默认模式：指数预测
      switchMlMode("index");

      // 单指数预测：调用 /api/ts_index_predict，结果画到统一 TS 图表（mlTsChart）上
      const indexPredBtn = document.getElementById("indexPredBtn");
      if (indexPredBtn) {
        indexPredBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "预测中...";

          const code = document.getElementById("indexPredCode").value;
          const horizon = Number(document.getElementById("indexPredHorizon").value || 8);

          const fd = new FormData();
          fd.append("ts_code", code);
          fd.append("horizon", String(horizon));

          fetch("/api/ts_index_predict", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              if (d.status === "error") {
                alert("指数预测失败：" + (d.msg || "未知错误"));
                return;
              }
              const hist = d.history || [];
              const fut = d.forecast || [];
              renderMlForecast({
                target_col: code,
                history: hist.map((p) => ({ y: p.value, date: p.date })),
                forecast: fut.map((p) => ({ y: p.value, date: p.date })),
              });
            })
            .catch((e) => {
              alert("指数预测请求失败：" + e);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 单只股票预测：调用 /api/ts_stock_predict，结果画到统一 TS 图表（mlTsChart）上
      const stockPredBtn = document.getElementById("stockPredBtn");
      if (stockPredBtn) {
        stockPredBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "预测中...";

          const code = document.getElementById("stockPredCode").value.trim();
          const horizon = Number(document.getElementById("stockPredHorizon").value || 8);
          if (!code) {
            alert("请先输入股票代码（ts_code）");
            btn.disabled = false;
            btn.textContent = original;
            return;
          }

          const fd = new FormData();
          fd.append("ts_code", code);
          fd.append("horizon", String(horizon));

          fetch("/api/ts_stock_predict", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              if (d.status === "error") {
                alert("股票预测失败：" + (d.msg || "未知错误"));
                return;
              }
              const hist = d.history || [];
              const fut = d.forecast || [];
              renderMlForecast({
                target_col: code,
                history: hist.map((p) => ({ y: p.value, date: p.date })),
                forecast: fut.map((p) => ({ y: p.value, date: p.date })),
              });
            })
            .catch((e) => {
              alert("股票预测请求失败：" + e);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 金融讯息可视化分析：TuShare 菁融短讯
      // 设置默认日期（今天）
      (function() {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 16);
        const startDateEl = document.getElementById("flashStartDate");
        const endDateEl = document.getElementById("flashEndDate");
        if (startDateEl && !startDateEl.value) {
          startDateEl.value = todayStr;
        }
        if (endDateEl && !endDateEl.value) {
          endDateEl.value = todayStr;
        }
      })();

      document.getElementById("flashBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        
        // 读取所有参数
        const startDateInput = document.getElementById("flashStartDate").value;
        const endDateInput = document.getElementById("flashEndDate").value;
        const src = document.getElementById("flashSrc").value || "sina";
        const keyword = document.getElementById("flashKeyword").value.trim();
        const limit = Number(document.getElementById("flashLimit").value || 80);
        
        // 转换日期格式：datetime-local (YYYY-MM-DDTHH:mm) -> TuShare 格式 (YYYY-MM-DD HH:mm:ss)
        let startDate = startDateInput ? startDateInput.replace("T", " ") + ":00" : "";
        let endDate = endDateInput ? endDateInput.replace("T", " ") + ":59" : "";
        
        btn.disabled = true;
        btn.textContent = "拉取中...";
        document.getElementById("flashStatus").innerText = `正在从 TuShare 拉取菁融短讯（优先 jrdc 接口，失败则用 news 接口）并生成词云/情感分析...`;

        // 构建查询参数
        const params = new URLSearchParams();
        if (startDate) params.append("start_date", startDate);
        if (endDate) params.append("end_date", endDate);
        params.append("src", src);
        params.append("limit", limit.toString());
        if (keyword) params.append("keyword", keyword);

        fetch(`/api/ts_flash_viz?${params.toString()}`)
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            document.getElementById("flashPreview").textContent = JSON.stringify(
              (d.items || []).slice(0, 30),
              null,
              2
            );
            // 列表展示：每条短讯 + 单条情感得分
            renderFlashList(d.items || []);
            updateFlashSentimentBar(d.sentiment || {});
            renderFlashSentimentChart(d.items || []); // 渲染情感比例饼图
            renderFlashWordCloud(d.words || []);
            renderFlashSourceChart(d.source_stats || []);
            renderFlashLenChart(d.length_buckets || []);
            document.getElementById("flashStatus").innerText = `完成：共 ${d.rows || 0} 条菁融短讯${keyword ? `（关键词: ${keyword}）` : ""}`;
            // 确保词云和饼图在可见尺寸下渲染
            setTimeout(() => {
              flashWordChart.resize();
              flashSentimentChart.resize();
            }, 0);
          })
          .catch((e) => {
            document.getElementById("flashStatus").innerText = "失败：" + e.message;
            alert("菁融短讯拉取失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      function loadTsMarket() {
        const btn = document.getElementById("tsBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "拉取中...";
        }
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("tsBtn").addEventListener("click", loadTsMarket);

      // 货币报价
      function loadFx() {
        const btn = document.getElementById("fxBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "刷新中...";
        }
        fetch("/api/ts_fx")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderFxTable(d);
          })
          .catch((e) => {
            alert("货币数据拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("fxBtn").addEventListener("click", loadFx);

      // 单股区间涨幅
      document.getElementById("stockBtn").addEventListener("click", function () {
        const code = document.getElementById("stockCode").value.trim();
        const start = document.getElementById("stockStart").value.trim();
        const end = document.getElementById("stockEnd").value.trim();
        if (!code || !start || !end) {
          alert("请完整填写股票代码和起止日期");
          return;
        }
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "查询中...";
        const fd = new FormData();
        fd.append("ts_code", code);
        fd.append("start_date", start);
        fd.append("end_date", end);
        fetch("/api/ts_stock_range", { method: "POST", body: fd })
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "查询失败");
            }
            renderStockRange(d.dates || [], d.cum_change || [], d.ts_code);
          })
          .catch((e) => {
            alert("区间涨幅查询失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      document.getElementById("tsBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "拉取中...";
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      document
        .getElementById("analyzeBtn")
        .addEventListener("click", function () {
          const formData = new FormData();

          // 数据部分
          const file = document.getElementById("fileInput").files[0];
          if (file) {
            formData.append("file", file);
          }
          formData.append(
            "text_data",
            document.getElementById("textData").value
          );
          formData.append(
            "dataset",
            document.getElementById("datasetSelect").value
          );
          formData.append("x_col", document.getElementById("xCol").value);
          formData.append("y_col", document.getElementById("yCol").value);

          // 文本与 AI 分析部分
          formData.append("doc_text", document.getElementById("docText").value);

          document.getElementById("statusText").innerText = "正在分析，请稍候…";

          fetch("/analyze", {
            method: "POST",
            body: formData,
          })
            .then((res) => {
              if (!res.ok) {
                return res.json().then(data => {
                  throw new Error(data.msg || `HTTP ${res.status}`);
                });
              }
              return res.json();
            })
            .then((data) => {
              if (data.status === "error") {
                throw new Error(data.msg || "分析失败");
              }
              
              document.getElementById("statusText").innerText = "分析完成 ✓";
              document.getElementById("statusText").className = "small text-success";

              // 更新数值摘要
              document.getElementById("xyLabel").innerText =
                "(X 轴：" + data.x_col + "，Y 轴：" + data.y_col + ")";
              document.getElementById("summaryBox").innerText =
                data.summary || "未获得有效的统计摘要，请检查数据。";

              // 更新 AI 摘要
              document.getElementById("aiSummary").innerText =
                data.ai_summary ||
                "未输入金融文本，暂无法给出 AI 摘要示例。";

              // 更新情感条
              updateSentimentBar(data.sentiment || {});

              // 更新输出文件列表
              const files = data.files || [];
              const span = document.getElementById("savedFiles");
              if (files.length > 0) {
                span.innerHTML =
                  "分析结果文件已保存在后端，可通过以下链接下载：" +
                  files
                    .map((p) => {
                      const name = p.split(/[\\/]/).slice(-1)[0];
                      return (
                        '<a href="/files/' +
                        name +
                        '" target="_blank" class="me-2">' +
                        name +
                        "</a>"
                      );
                    })
                    .join("");
              } else {
                span.innerHTML = "";
              }

              // 更新五类图表
              updateCharts(data);
            })
            .catch((err) => {
              console.error(err);
              document.getElementById("statusText").innerText =
                "分析失败：" + err.message;
              document.getElementById("statusText").className = "small text-danger";
              
              // 显示错误提示
              alert("分析失败：" + err.message + "\n请检查数据格式或网络连接。");
            });
        });

      // 自适应窗口尺寸
      window.addEventListener("resize", function () {
        chartLine.resize();
        chartBar.resize();
        chartPie.resize();
        chartScatter.resize();
        chartBox.resize();
        wordChart.resize();
        predictChart.resize();
      });
    </script>
  </body>
</html>


