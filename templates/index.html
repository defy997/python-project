<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>金融数据与文献综合分析系统</title>
    <!-- 引入 Bootstrap 与 ECharts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
      body {
        background-color: #f5f7fa;
      }
      .page-title {
        font-weight: 600;
        letter-spacing: 0.08em;
      }
      .chart-card {
        background: #fff;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(15, 35, 52, 0.08);
        height: 360px;
      }
      .chart-box {
        width: 100%;
        height: 100%;
      }
      .section-title {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .summary-box {
        white-space: pre-wrap;
        background: #fff;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid #0d6efd;
        font-size: 0.95rem;
      }
      .sentiment-bar {
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
      }
      .sentiment-seg {
        height: 100%;
      }
      .sentiment-pos {
        background: #4caf50;
      }
      .sentiment-neu {
        background: #ffc107;
      }
      .sentiment-neg {
        background: #f44336;
      }
      /* 分页内容容器：默认隐藏，激活时显示 */
      .section-block {
        display: none;
      }
      .section-block.active {
        display: block;
      }
      /* 左上角随机头像 */
      .corner-avatar {
        position: fixed;
        top: 12px;
        left: 12px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 2px solid #0d6efd;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 9999;
        object-fit: cover;
      }
    </style>
  </head>

  <body>
    <!-- 左上角随机头像 -->
    <img id="cornerAvatar" class="corner-avatar" src="http://api.guiguiya.com/api/img/miyoushe/avatar" alt="avatar" />

    <div class="container-fluid py-3">
      <div class="mb-3 text-center">
        <h2 class="page-title">金融数据与文献综合分析系统</h2>
        <p class="text-muted small mb-1">
          通过前后端交互，对金融数据进行多维度可视化分析，并借助“AI 模型”进行文献摘要与情感分析。
        </p>
        <!-- 原 crawler_ml 独立页面已下线，这里去掉跳转提示 -->
      </div>

      <!-- 布局：左侧侧边栏 + 右侧分页内容 -->
      <div class="row">
        <div class="col-md-2 col-lg-2 mb-3">
          <div class="list-group shadow-sm" id="sideNav">
            <a class="list-group-item list-group-item-action" data-target="section-wordcloud" href="#">词云</a>
            <a class="list-group-item list-group-item-action" data-target="section-sentiment" href="#">金融讯息可视化分析</a>
            <a class="list-group-item list-group-item-action" data-target="section-predict" href="#">股票预测</a>
          </div>
        </div>

        <!-- 右侧主体内容（分页切换） -->
        <div class="col-md-10 col-lg-10">

        <!-- 词云 -->
        <div class="card shadow-sm mb-3 section-block" id="section-wordcloud">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">一、词云可视化</div>
              <small class="text-muted">选择数据来源，浏览新闻标题，点击标题生成词云</small>
            </div>
            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-3">
                <label class="form-label">数据来源</label>
                <select id="wcSource" class="form-select">
                  <option value="sina" selected>新浪财经</option>
                  <option value="eastmoney">东方财富</option>
                  <option value="wallstreetcn">华尔街见闻</option>
                  <option value="10jqka">同花顺</option>
                  <option value="yuncaijing">云财经</option>
                  <option value="fenghuang">凤凰新闻</option>
                  <option value="jinrongjie">金融界</option>
                  <option value="cls">财联社</option>
                  <option value="yicai">第一财经</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">关键词搜索（可选）</label>
                <input id="wcKeyword" type="text" class="form-control" placeholder="如：美联储" />
              </div>
              <div class="col-md-2">
                <label class="form-label">条数</label>
                <input id="wcLimit" type="number" min="10" max="200" value="50" class="form-control" />
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" id="wcLoadBtn">加载新闻</button>
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" id="wcBtn" disabled>生成词云</button>
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-md-12 small text-muted" id="wcStatus"></div>
            </div>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.9rem;">新闻标题列表（点击选择）</div>
                <div id="wcNewsList" style="max-height:300px;overflow:auto;border:1px solid #dee2e6;border-radius:4px;padding:10px;" class="small">
                  <div class="text-muted text-center">请先点击"加载新闻"获取新闻列表</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.9rem;">词云</div>
                <div id="wordCloud" style="height:300px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 金融讯息可视化分析 -->
        <div class="card shadow-sm mb-3 section-block" id="section-sentiment">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">三、金融讯息可视化分析</div>
             
            </div>
            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-2">
                <label class="form-label">开始日期</label>
                <input id="flashStartDate" type="datetime-local" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label">结束日期</label>
                <input id="flashEndDate" type="datetime-local" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label">数据源（src）</label>
                <select id="flashSrc" class="form-select">
                  <option value="sina" selected>新浪财经</option>
                  <option value="wallstreetcn">华尔街见闻</option>
                  <option value="10jqka">同花顺</option>
                  <option value="eastmoney">东方财富</option>
                  <option value="yuncaijing">云财经</option>
                  <option value="fenghuang">凤凰新闻</option>
                  <option value="jinrongjie">金融界</option>
                  <option value="cls">财联社</option>
                  <option value="yicai">第一财经</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">关键词搜索</label>
                <input id="flashKeyword" type="text" class="form-control" placeholder="可选，留空则不过滤" />
              </div>
              <div class="col-md-2">
                <label class="form-label">条数（limit）</label>
                <input id="flashLimit" type="number" min="10" max="1500" value="80" class="form-control" />
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" id="flashBtn">拉取</button>
              </div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-md-12 small text-muted" id="flashStatus"></div>
            </div>
            <!-- 短讯原始 JSON 预览（已隐藏） -->
            <pre class="bg-dark text-light p-2 small" style="max-height:160px;overflow:auto;display:none" id="flashPreview"></pre>
            <!-- 每条短讯 + 单条情感得分列表 -->
            <div class="mt-2 small" style="max-height:220px;overflow:auto" id="flashList"></div>
            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <div class="section-title mb-1" style="font-size:0.95rem;">情感分析</div>
                <div class="sentiment-bar mb-1">
                  <div id="flashSentPos" class="sentiment-seg sentiment-pos" style="width:33%"></div>
                  <div id="flashSentNeu" class="sentiment-seg sentiment-neu" style="width:34%"></div>
                  <div id="flashSentNeg" class="sentiment-seg sentiment-neg" style="width:33%"></div>
                </div>
                <div class="small">
                  <span class="text-success">正向：</span><span id="flashSentPosText">-</span>，
                  <span class="text-warning">中性：</span><span id="flashSentNeuText">-</span>，
                  <span class="text-danger">负向：</span><span id="flashSentNegText">-</span>
                </div>
              </div>
              <div class="col-md-4 offset-md-1">
                <div class="section-title mb-1" style="font-size:0.95rem;">情感比例分布</div>
                <div id="flashSentimentChart" style="height:200px;"></div>
              </div>
              <div class="col-md-4">
                <div class="section-title mb-1" style="font-size:0.95rem;">词云</div>
                <div id="flashWordCloud" style="height:260px"></div>
              </div>
            </div>

            <!-- 额外图表：来源分布 + 文本长度分布 -->
            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.95rem;">来源分布</div>
                <div id="flashSourceChart" style="height:220px;"></div>
              </div>
              <div class="col-md-6">
                <div class="section-title mb-1" style="font-size:0.95rem;">文本长度分布</div>
                <div id="flashLenChart" style="height:260px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 股票预测 / TuShare 多指数 -->
        <div class="card shadow-sm mb-3 section-block" id="section-predict">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">四、TuShare 多指数行情</div>
              <small class="text-muted">拉取上证/深成/创业/沪深300/中证500 等指数，自动绘制多折线</small>
            </div>

            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-4">
                <button class="btn btn-success w-100" id="tsBtn">拉取 TuShare 指数行情</button>
              </div>
            </div>

            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">多指数走势</div>
                <div id="predictChart" style="height:320px"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">最新报价</div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0" id="tsTable">
                    <thead>
                      <tr>
                        <th>指数</th>
                        <th>最新价</th>
                        <th>涨跌幅</th>
                        <th>日期</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 货币板块 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="section-title mb-0" style="font-size: 0.95rem;">货币（相对人民币）</div>
                  <button class="btn btn-outline-secondary btn-sm" id="fxBtn">刷新货币报价</button>
                </div>
                <div class="table-responsive mb-2">
                  <table class="table table-sm table-striped mb-0" id="fxTable">
                    <thead>
                      <tr>
                        <th>货币</th>
                        <th>符号</th>
                        <th>价格</th>
                        <th>涨跌额</th>
                        <th>涨跌幅</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="small text-muted mb-1">
                  提示：点击上表中的“美元/人民币、英镑/人民币、日元/人民币”任意一行，可查看近期走势折线图。
                </div>
                <div id="fxChart" style="height:260px;"></div>
              </div>
            </div>

            <!-- 单只股票区间涨幅 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">单只股票区间涨幅分析</div>
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">股票代码（ts_code）</label>
                    <input id="stockCode" class="form-control" placeholder="如：600519.SH" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">开始日期</label>
                    <input id="stockStart" class="form-control" placeholder="如：20250101" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">结束日期</label>
                    <input id="stockEnd" class="form-control" placeholder="如：20251231" />
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="stockBtn">查询涨幅</button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-md-6">
                    <div class="section-title mb-1" style="font-size:0.9rem;">累计涨幅</div>
                    <div id="stockChart" style="height:260px;"></div>
                  </div>
                  <div class="col-md-6">
                    <div class="section-title mb-1" style="font-size:0.9rem;">因子模型与回归分析</div>
                    <div id="stockRiskReturnChart" style="height:260px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 统一预测面板：指数 / 股票 / 通用 ML -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size:0.95rem;">机器学习与时间序列预测</div>

                <!-- 预测类型切换 -->
                <div class="mb-2">
                  <label class="form-label me-2">预测类型：</label>
                  <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeIndex" value="index" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="mlModeIndex">指数预测</label>
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeStock" value="stock" autocomplete="off">
                    <label class="btn btn-outline-primary" for="mlModeStock">股票预测</label>
                    <input type="radio" class="btn-check" name="mlMode" id="mlModeGeneric" value="generic" autocomplete="off">
                    <label class="btn btn-outline-primary" for="mlModeGeneric">通用 ML</label>
                  </div>
                </div>

                <!-- 指数预测表单 -->
                <div id="mlPanelIndex" class="mb-2">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">选择指数</label>
                      <select id="indexPredCode" class="form-select">
                        <option value="000001.SH">上证指数 (000001.SH)</option>
                        <option value="399001.SZ">深证成指 (399001.SZ)</option>
                        <option value="399006.SZ">创业板指 (399006.SZ)</option>
                        <option value="000300.SH">沪深300 (000300.SH)</option>
                        <option value="000905.SH">中证500 (000905.SH)</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="indexPredHorizon" type="number" min="3" max="60" value="8" class="form-control" />
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-outline-info w-100" id="indexPredBtn">生成指数预测</button>
                    </div>
                  </div>
                </div>

                <!-- 股票预测表单 -->
                <div id="mlPanelStock" class="mb-2" style="display:none;">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">股票代码（ts_code）</label>
                      <input id="stockPredCode" class="form-control" placeholder="如：600519.SH" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="stockPredHorizon" type="number" min="3" max="60" value="8" class="form-control" />
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-outline-success w-100" id="stockPredBtn">生成股票预测</button>
                    </div>
                  </div>
                </div>

                <!-- 通用 ML 表单 -->
                <div id="mlPanelGeneric" class="mb-2" style="display:none;">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                      <label class="form-label">选择表（仅展示可用于预测的表）</label>
                      <select id="mlTable" class="form-select"></select>
                    </div>
                    <div class="col-md-5">
                      <label class="form-label">特征列（可多选，按 Ctrl/Shift 选择）</label>
                      <select id="mlFeatures" class="form-select" multiple size="4"></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">目标列（可选）</label>
                      <select id="mlTarget" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">预测步数</label>
                      <input id="mlHorizon" type="number" min="0" max="60" value="0" class="form-control" />
                    </div>
                    <div class="col-md-2 mt-2">
                      <button class="btn btn-outline-primary w-100" id="mlBtn">运行 ML 模型</button>
                    </div>
                  </div>
                  <div class="small text-muted mt-1">
                    说明：仅展示外汇等可用于时间序列/价格预测的表；若目标列为空，则只运行聚类；若指定目标列且存在，则同时运行回归与分类。
                  </div>
                  <pre id="mlResult" class="bg-dark text-light p-2 small mt-2" style="max-height:180px;overflow:auto;"></pre>
                </div>

                <!-- 通用 ML 指标图表（仅通用 ML 模式下使用） -->
                <div id="mlGenericCharts">
                  <div class="row g-2 mt-2">
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">回归指标</div>
                          <div id="mlChartReg" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">分类指标</div>
                          <div id="mlChartCls" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="section-title mb-1" style="font-size:0.95rem;">聚类指标</div>
                          <div id="mlChartClu" style="height:220px;"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 统一时间序列 / 指数 / 股票预测曲线 -->
                <div class="card mt-2">
                  <div class="card-body p-2">
                    <div class="section-title mb-1" style="font-size:0.95rem;">时间序列与预测</div>
                    <div id="mlTsChart" style="height:260px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        </div> <!-- /右侧主体 -->
      </div> <!-- /row -->

      <footer class="text-center text-muted small py-2">
        课程实验示例 &copy; 金融数据分析与 AI 应用
      </footer>
    </div>

    <script>
      // 初始化图表实例
      const wordChart = echarts.init(document.getElementById("wordCloud"));
      const flashWordChart = echarts.init(document.getElementById("flashWordCloud"));
      const flashSourceChart = echarts.init(document.getElementById("flashSourceChart"));
      const flashLenChart = echarts.init(document.getElementById("flashLenChart"));
      const flashSentimentChart = echarts.init(document.getElementById("flashSentimentChart"));
      const predictChart = echarts.init(document.getElementById("predictChart"));

      // 外汇折线图：页面初始时可能处于隐藏分页，直接 init 会导致 0 宽高渲染失败
      function getFxChart() {
        const dom = document.getElementById("fxChart");
        if (!dom) return null;
        let inst = echarts.getInstanceByDom(dom);
        if (!inst) inst = echarts.init(dom);
        return inst;
      }

      // 侧边栏分页切换
      const sectionBlocks = document.querySelectorAll(".section-block");
      const sideLinks = document.querySelectorAll("#sideNav a[data-target]");
      let predictLoaded = false;

      function showSection(id) {
        sectionBlocks.forEach((sec) => {
          sec.classList.toggle("active", sec.id === id);
        });
        sideLinks.forEach((link) => {
          link.classList.toggle("active", link.dataset.target === id);
        });

        // 首次切换到"股票预测"分页时自动获取指数与货币数据 + 加载 ML 表结构
        if (id === "section-predict" && !predictLoaded) {
          if (typeof loadTsMarket === "function") {
            loadTsMarket();
          }
          if (typeof loadFx === "function") {
            loadFx();
          }
          if (typeof loadMlSchema === "function") {
            loadMlSchema();
          }
          predictLoaded = true;
        }

        // 首次切换到"词云"分页时确保图表正确显示
        if (id === "section-wordcloud") {
          setTimeout(() => {
            wordChart.resize();
          }, 0);
        }

        // 切换到股票预测分页后，强制 resize 所有图表，避免图表容器初始宽高为 0
        if (id === "section-predict") {
          setTimeout(() => {
            if (predictChart) predictChart.resize();
            const c = getFxChart();
            if (c) c.resize();
            // 股票区间图表
            const stockDom = document.getElementById("stockChart");
            if (stockDom) {
              const stockInst = echarts.getInstanceByDom(stockDom);
              if (stockInst) stockInst.resize();
            }
            // 风险收益分析散点图
            const riskReturnDom = document.getElementById("stockRiskReturnChart");
            if (riskReturnDom) {
              const riskReturnInst = echarts.getInstanceByDom(riskReturnDom);
              if (riskReturnInst) riskReturnInst.resize();
            }
          }, 50);
        }
      }

      sideLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          showSection(this.dataset.target);
        });
      });

      // 默认显示第一个分页
      if (sideLinks.length > 0) {
        showSection(sideLinks[0].dataset.target);
      }

      // 简单 HTML 转义，避免标题中出现标签时影响页面
      function htmlEscape(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // 渲染 ML 指标条形图
      function renderMlMetrics(domId, metrics, title = "") {
        const dom = document.getElementById(domId);
        if (!dom) return;
        let chart = echarts.getInstanceByDom(dom);
        if (!chart) chart = echarts.init(dom);

        const entries = Object.entries(metrics || {}).filter(
          ([, v]) => typeof v === "number" && isFinite(v)
        );

        if (entries.length === 0) {
          chart.setOption({
            title: { text: title || "无可用指标", left: "center", textStyle: { fontSize: 12 } },
            xAxis: { show: false }, yAxis: { show: false }, series: [],
          });
          return;
        }

        const names = entries.map(([k]) => k);
        const values = entries.map(([, v]) => v);

        chart.setOption({
          title: { text: title, left: "center", textStyle: { fontSize: 12 } },
          tooltip: { trigger: "axis" },
          grid: { left: 60, right: 20, top: 30, bottom: 20 },
          xAxis: { type: "value" },
          yAxis: { type: "category", data: names },
          series: [
            { type: "bar", data: values, itemStyle: { color: "#0d6efd" } },
          ],
        });
      }

      // 渲染 ML 时间序列预测
      function renderMlForecast(ts) {
        const dom = document.getElementById("mlTsChart");
        if (!dom) return;
        let chart = echarts.getInstanceByDom(dom);
        if (!chart) chart = echarts.init(dom);

        if (!ts || !Array.isArray(ts.history) || ts.history.length === 0) {
          chart.setOption({
            title: { text: "暂无时间序列数据", left: "center", textStyle: { fontSize: 12 } },
            xAxis: { show: false }, yAxis: { show: false }, series: [],
          });
          return;
        }

        const fullHist = ts.history || [];
        const fut = ts.forecast || [];

        // 为了保证右侧的“预测部分”始终清晰可见，如果点太多，只展示
        // “最近一段历史 + 全部预测”，从右往左回看。
        const MAX_POINTS = 80; // 视图中最多展示的总点数（历史 + 预测）
        let hist = fullHist;
        if (fullHist.length + fut.length > MAX_POINTS) {
          const keepHist = Math.max(10, MAX_POINTS - fut.length); // 至少保留一些历史
          hist = fullHist.slice(-keepHist);
        }

        // 横坐标优先使用日期（date），否则退回到 x 或索引
        const histLabels = hist.map((p, idx) => p.date ?? p.x ?? idx);
        const futLabels = fut.map(
          (p, idx) => p.date ?? `t+${idx + 1}`
        );

        const xs = histLabels.concat(futLabels);
        const ysHist = hist.map((p) => p.y);
        const ysFut = new Array(histLabels.length)
          .fill(null)
          .concat(fut.map((p) => p.y));

        chart.setOption({
          title: {
            text: `目标列 ${ts.target_col || ""} 的历史与预测`,
            left: "center",
            textStyle: { fontSize: 12 },
          },
          tooltip: { trigger: "axis" },
          legend: { top: 20, data: ["历史", "预测"] },
          grid: { left: 60, right: 20, top: 50, bottom: 30 },
          xAxis: { type: "category", data: xs, name: "时间" },
          yAxis: { type: "value", name: "数值" },
          series: [
            {
              name: "历史",
              type: "line",
              smooth: true,
              data: ysHist,
            },
            {
              name: "预测",
              type: "line",
              smooth: true,
              data: ysFut,
            },
          ],
        });
      }

      // 设置空白初始配置
      wordChart.setOption({ title: { show: false }, series: [] });
      predictChart.setOption({ title: { text: "等待数据...", left: "center" } });
      flashSourceChart.setOption({ title: { show: false }, series: [] });
      flashLenChart.setOption({ title: { show: false }, series: [] });
      flashSentimentChart.setOption({ 
        title: { show: false },
        legend: { show: false },
        series: []
      });

      // 加载 ML 可选表与列
      function loadMlSchema() {
        fetch("/api/ml_schema")
          .then((r) => r.json())
          .then((d) => {
            if (d.status === "error") throw new Error(d.msg || "加载失败");
            const tables = d.tables || [];
            const tableSel = document.getElementById("mlTable");
            const featSel = document.getElementById("mlFeatures");
            const targetSel = document.getElementById("mlTarget");
            if (!tableSel || !featSel || !targetSel) return;

            tableSel.innerHTML = "";
            tables.forEach((t, idx) => {
              const opt = document.createElement("option");
              opt.value = t.name;
              opt.textContent = t.label || t.name;
              if (idx === 0) opt.selected = true;
              tableSel.appendChild(opt);
            });

            function updateCols() {
              const current = tableSel.value;
              const info = tables.find((t) => t.name === current);
              const cols = (info && info.columns) || [];
              featSel.innerHTML = "";
              targetSel.innerHTML = "";
              cols.forEach((c) => {
                const opt1 = document.createElement("option");
                opt1.value = c;
                opt1.textContent = c;
                featSel.appendChild(opt1);

                const opt2 = document.createElement("option");
                opt2.value = c;
                opt2.textContent = c;
                targetSel.appendChild(opt2);
              });
              // 默认：特征列全部不选，由用户手动选择；目标列默认选最后一列
              if (targetSel.options.length > 0) {
                targetSel.options[targetSel.options.length - 1].selected = true;
              }
            }

            tableSel.addEventListener("change", updateCols);
            updateCols();
          })
          .catch((e) => {
            const box = document.getElementById("mlResult");
            if (box) box.textContent = "ML 表结构加载失败：" + e.message;
          });
      }

      /**
       * 辅助函数：更新情感条与文本
       */
      function updateSentimentBar(sentiment) {
        const p = Math.round((sentiment.positive || 0) * 100);
        const n = Math.round((sentiment.neutral || 0) * 100);
        const g = Math.round((sentiment.negative || 0) * 100);
        document.getElementById("sentPos").style.width = p + "%";
        document.getElementById("sentNeu").style.width = n + "%";
        document.getElementById("sentNeg").style.width = g + "%";
        document.getElementById("sentPosText").innerText = p + "%";
        document.getElementById("sentNeuText").innerText = n + "%";
        document.getElementById("sentNegText").innerText = g + "%";
      }

      /**
       * 菁融短讯：渲染“每条短讯 + 单条情感得分”列表
       */
      function renderFlashList(items) {
        const box = document.getElementById("flashList");
        if (!box) return;
        box.innerHTML = "";
        (items || []).forEach((it, idx) => {
          const s = it.sentiment || {};
          // 计算综合得分：正向接近1，中性接近0.6，负向接近0
          const p = s.positive !== undefined ? s.positive : 0;
          const n = s.neutral !== undefined ? s.neutral : 0;
          const g = s.negative !== undefined ? s.negative : 0;
          
          // 综合得分公式：正向*1.0 + 中性*0.6 + 负向*0.0
          const compositeScore = p * 1.0 + n * 0.6 + g * 0.0;
          
          // 根据得分确定颜色
          let scoreClass = "text-warning"; // 默认中性（黄色）
          if (compositeScore >= 0.7) {
            scoreClass = "text-success"; // 正向（绿色）
          } else if (compositeScore <= 0.3) {
            scoreClass = "text-danger"; // 负向（红色）
          }
          
          const t = it.pub_time || it.datetime || "";
          const title = it.title || "(无标题)";
          const src = it.src || "";
          const url = it.url || "";
          const div = document.createElement("div");
          div.className = "mb-1";
          const titleHtml = url
            ? `<a href="${htmlEscape(url)}" target="_blank" rel="noopener" class="text-primary">${htmlEscape(title)}</a>`
            : `<span class="text-primary">${htmlEscape(title)}</span>`;
          div.innerHTML =
            `<span class="text-muted">${idx + 1}.</span> ` +
            (t ? `[${htmlEscape(t)}] ` : "") +
            titleHtml +
            (src ? ` <span class="text-muted">(${htmlEscape(src)})</span>` : "") +
            ` <span class="ms-1 ${scoreClass}">得分:${compositeScore}</span>`;
          box.appendChild(div);
        });
      }


      /**
       * 词云渲染
       */
      function renderWordCloud(words) {
        wordChart.setOption({
          tooltip: {},
          series: [
            {
              type: "wordCloud",
              shape: "circle",
              sizeRange: [12, 42],
              rotationRange: [-45, 45],
              gridSize: 6,
              textStyle: {
                color: () =>
                  "rgb(" +
                  [
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                  ].join(",") +
                  ")",
              },
              data: words,
            },
          ],
        });
      }

      function renderFlashWordCloud(words) {
        flashWordChart.setOption({
          tooltip: {},
          series: [
            {
              type: "wordCloud",
              shape: "circle",
              gridSize: 6,
              sizeRange: [10, 44],
              rotationRange: [-30, 30],
              textStyle: {
                color: function () {
                  const colors = ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272"];
                  return colors[Math.floor(Math.random() * colors.length)];
                },
              },
              data: words,
            },
          ],
        });
      }

      // 金融讯息：来源分布图（饼图）
      function renderFlashSourceChart(stats) {
        const data = stats || [];
        const hasData = Array.isArray(data) && data.length > 0;
        if (!hasData) {
          flashSourceChart.setOption({
            title: { show: false },
            series: [],
          });
          return;
        }
        
        // 为数据添加颜色（如果没有）
        const colors = ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272", "#fc8452", "#9a60b4", "#ea7ccc", "#5ab1ef"];
        const dataWithColors = data.map((item, index) => ({
          name: item.name || item.label || "未知",
          value: item.value || 0,
          itemStyle: { color: colors[index % colors.length] }
        }));
        
        flashSourceChart.setOption({
          tooltip: { 
            trigger: "item",
            formatter: "{b}: {c} ({d}%)"
          },
          legend: { 
            top: 10,
            left: "center",
            orient: "horizontal"
          },
          series: [
            {
              type: "pie",
              radius: ["40%", "70%"], // 环形图
              center: ["50%", "55%"],
              avoidLabelOverlap: true,
              itemStyle: {
                borderRadius: 5,
                borderColor: "#fff",
                borderWidth: 2
              },
              label: {
                show: true,
                formatter: "{b}\n{c} ({d}%)",
                fontSize: 11
              },
              emphasis: {
                label: {
                  show: true,
                  fontSize: 13,
                  fontWeight: "bold"
                }
              },
              data: dataWithColors,
            },
          ],
        });
        // 确保图表正确渲染
        flashSourceChart.resize();
      }

      // 金融讯息：文本长度分布（柱状图）
      function renderFlashLenChart(buckets) {
        const data = buckets || [];
        const hasData = Array.isArray(data) && data.length > 0;
        if (!hasData) {
          flashLenChart.setOption({
            title: { show: false },
            xAxis: { show: false },
            yAxis: { show: false },
            series: [],
          });
          return;
        }
        const names = data.map((d) => d.name);
        const values = data.map((d) => d.value);
        flashLenChart.setOption({
          tooltip: { trigger: "axis" },
          grid: { left: 40, right: 20, top: 30, bottom: 30 },
          xAxis: { type: "category", data: names },
          yAxis: { type: "value" },
          series: [
            {
              type: "bar",
              barWidth: "50%", // 减小柱体宽度
              data: values,
              itemStyle: { color: "#0d6efd" },
            },
          ],
        });
      }

      // 金融讯息：情感比例分布（饼图）
      function renderFlashSentimentChart(items) {
        if (!items || items.length === 0) {
          flashSentimentChart.setOption({
            title: { show: false },
            legend: { show: false },
            series: [],
          });
          return;
        }

        // 计算所有新闻的情感平均值
        let totalPos = 0;
        let totalNeu = 0;
        let totalNeg = 0;
        let count = 0;

        items.forEach((it) => {
          const s = it.sentiment || {};
          if (s.positive !== undefined || s.neutral !== undefined || s.negative !== undefined) {
            totalPos += s.positive || 0;
            totalNeu += s.neutral || 0;
            totalNeg += s.negative || 0;
            count++;
          }
        });

        if (count === 0) {
          flashSentimentChart.setOption({
            title: { show: false },
            legend: { show: false },
            series: [],
          });
          return;
        }

        // 计算平均值并转换为百分比
        const avgPos = (totalPos / count) * 100;
        const avgNeu = (totalNeu / count) * 100;
        const avgNeg = (totalNeg / count) * 100;

        const data = [
          { value: avgPos, name: "正向", itemStyle: { color: "#28a745" } },
          { value: avgNeu, name: "中性", itemStyle: { color: "#ffc107" } },
          { value: avgNeg, name: "负向", itemStyle: { color: "#dc3545" } },
        ];

        flashSentimentChart.setOption({
          tooltip: {
            trigger: "item",
            formatter: "{b}: {c}% ({d}%)",
          },
          legend: {
            top: 10,
            left: "right",  // 改为右对齐，布局往右一点
            orient: "vertical",  // 垂直排列
          },
          series: [
            {
              type: "pie",
              radius: "65%",
              center: ["40%", "55%"],  // 饼图稍微往左移，为右侧legend留空间
              data: data,
              label: {
                formatter: "{b}: {c}%",
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: "rgba(0, 0, 0, 0.5)",
                },
              },
            },
          ],
        });
      }

      function updateFlashSentimentBar(sentiment) {
        const s = sentiment || {};
        const p = Math.max(0, Math.min(1, s.positive ?? 0.33));
        const n = Math.max(0, Math.min(1, s.neutral ?? 0.34));
        const g = Math.max(0, Math.min(1, s.negative ?? 0.33));
        document.getElementById("flashSentPos").style.width = `${Math.round(p * 100)}%`;
        document.getElementById("flashSentNeu").style.width = `${Math.round(n * 100)}%`;
        document.getElementById("flashSentNeg").style.width = `${Math.round(g * 100)}%`;
        document.getElementById("flashSentPosText").innerText = `${Math.round(p * 100)}%`;
        document.getElementById("flashSentNeuText").innerText = `${Math.round(n * 100)}%`;
        document.getElementById("flashSentNegText").innerText = `${Math.round(g * 100)}%`;
      }

      /**
       * 股票预测渲染
       */
      function renderPredict(history, forecast, yCol) {
        const histData = history.map((d) => [d.x, d.y]);
        const futData = forecast.map((d) => [d.x, d.y]);
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "value" },
          yAxis: { type: "value", name: yCol || "price" },
          series: [
            {
              name: "历史",
              type: "line",
              data: histData,
              smooth: true,
              symbol: "circle",
            },
            {
              name: "预测",
              type: "line",
              data: futData,
              smooth: true,
              lineStyle: { type: "dashed" },
              symbol: "triangle",
            },
          ],
        });
      }

      /**
       * TuShare 指数行情渲染
       */
      function renderTsMarket(data) {
        const x = (data.x || []).map((d) => d);
        const series = data.series || [];
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          legend: {
            top: 10,
            type: "scroll", // 当图例较多时可横向滚动
            orient: "horizontal",
            itemGap: 18,
            textStyle: {
              fontSize: 12,
            },
          },
          xAxis: {
            type: "category",
            data: x,
          },
          yAxis: { type: "value", name: "指数点位" },
          series,
        });

        // 填充表格
        const tbody = document.querySelector("#tsTable tbody");
        tbody.innerHTML = "";
        (data.latest || []).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}%</td>
            <td>${row.date}</td>
          `;
          tbody.appendChild(tr);
        });

        // 如果存在缺失的指数，给出提示
        if (data.missing && data.missing.length > 0) {
          const msg = "以下指数未能从 TuShare 拉取，使用占位数据：" + data.missing.join("、");
          predictChart.setOption({
            title: { text: msg, left: "center", textStyle: { fontSize: 12 } },
          });
        } else {
          predictChart.setOption({ title: { text: "" } });
        }
      }

      /**
       * 货币表渲染
       */
      function renderFxTable(data) {
        const tbody = document.querySelector("#fxTable tbody");
        tbody.innerHTML = "";
        (data.currencies || []).forEach((row) => {
          const tr = document.createElement("tr");
          if (row.pair) {
            tr.dataset.pair = row.pair;
            tr.dataset.name = row.name || "";
            tr.style.cursor = "pointer";
            tr.title = "点击查看近期走势";
          }
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.symbol}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}</td>
            <td class="${row.pct >= 0 ? "text-success" : "text-danger"}">${row.pct}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      /**
       * 加载单个货币对的近期走势（相对人民币）
       */
      function loadFxHistory(pair, name) {
        const days = 60; // 默认查看近 60 天
        fetch(`/api/fx_history?pair=${encodeURIComponent(pair)}&days=${days}`)
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            const dates = d.dates || [];
            const closes = d.closes || [];
            const fxChart = getFxChart();
            if (!fxChart) return;

            // y 轴区间：默认按数据自适应并加边距；USDCNY 可按 8~10 展示
            let yMin = null;
            let yMax = null;
            const nums = (closes || []).map((v) => Number(v)).filter((v) => Number.isFinite(v));
            if (nums.length > 0) {
              const minV = Math.min(...nums);
              const maxV = Math.max(...nums);
              const span = Math.max(1e-9, maxV - minV);
              const pad = span * 0.08; // 8% 边距
              yMin = minV - pad;
              yMax = maxV + pad;
            }

            // 美元/人民币：优先用 7~8 的可读区间，但不截断真实数据
            if (pair === "USDCNY") {
              const preferMin = 7;
              const preferMax = 8;
              if (yMin == null || yMax == null) {
                yMin = preferMin;
                yMax = preferMax;
              } else {
                yMin = Math.min(yMin, preferMin);
                yMax = Math.max(yMax, preferMax);
              }
            }

            fxChart.setOption({
              tooltip: { trigger: "axis" },
              title: {
                text: `${d.name || name} 近期走势（相对人民币）`,
                left: "center",
                textStyle: { fontSize: 12 },
              },
              xAxis: { type: "category", data: dates },
              yAxis: { type: "value", name: "汇率", min: yMin, max: yMax },
              series: [
                {
                  name: d.symbol || pair,
                  type: "line",
                  smooth: true,
                  data: closes,
                },
              ],
            });
            // 确保在可见尺寸下渲染
            setTimeout(() => fxChart.resize(), 0);
          })
          .catch((e) => {
            alert("货币历史数据拉取失败：" + e.message);
          });
      }

      // 货币表：使用事件委托，避免重复绑定或渲染后丢失事件
      const fxTbody = document.querySelector("#fxTable tbody");
      if (fxTbody) {
        fxTbody.addEventListener("click", (ev) => {
          const tr = ev.target && ev.target.closest ? ev.target.closest("tr") : null;
          if (!tr) return;
          const pair = tr.dataset.pair;
          if (!pair) return;
          loadFxHistory(pair, tr.dataset.name || pair);
        });
      }

      /**
       * 单股区间涨幅图渲染
       */
      function renderStockRange(dates, cumChange, code) {
        const dom = document.getElementById("stockChart");
        if (!dom) return;
        const stockChart = echarts.getInstanceByDom(dom) || echarts.init(dom);
        stockChart.setOption({
          tooltip: { trigger: "axis" },
          grid: { left: 50, right: 20, top: 20, bottom: 40 },
          xAxis: { type: "category", data: dates },
          yAxis: { type: "value", name: "累计涨幅(%)" },
          series: [
            {
              name: code,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: cumChange,
            },
          ],
        });
      }

      /**
       * 因子模型与回归分析散点图渲染
       */
      function renderStockFactorModel(factorModel, code) {
        const dom = document.getElementById("stockRiskReturnChart");
        if (!dom) return;
        const factorChart = echarts.getInstanceByDom(dom) || echarts.init(dom);
        
        if (!factorModel || !factorModel.scatter_data || factorModel.scatter_data.length === 0) {
          factorChart.setOption({
            title: { show: false },
            series: [],
          });
          return;
        }

        const scatterData = factorModel.scatter_data;
        const regressionLine = factorModel.regression_line || [];
        const beta = factorModel.beta || 0;
        const alpha = factorModel.alpha || 0;
        const rSquared = factorModel.r_squared || 0;
        const marketCode = factorModel.market_code || "000300.SH";
        
        // 计算残差（数据点与回归线的偏离）
        const residuals = scatterData.map(point => {
          const marketRet = point[0];
          const stockRet = point[1];
          const predictedRet = alpha + beta * marketRet;
          return Math.abs(stockRet - predictedRet);
        });
        const maxResidual = Math.max(...residuals);
        
        factorChart.setOption({
          tooltip: {
            trigger: "item",
            formatter: function(params) {
              if (params.seriesName === "回归线") {
                return `回归线<br/>Y = ${alpha.toFixed(4)} + ${beta.toFixed(4)} × X<br/>R² = ${rSquared.toFixed(4)}`;
              }
              const point = params.data;
              const marketRet = point[0];
              const stockRet = point[1];
              const predictedRet = alpha + beta * marketRet;
              const residual = stockRet - predictedRet;
              return `${code || "股票"}<br/>市场收益率: ${marketRet.toFixed(4)}%<br/>个股收益率: ${stockRet.toFixed(4)}%<br/>预测收益率: ${predictedRet.toFixed(4)}%<br/>残差: ${residual.toFixed(4)}%`;
            }
          },
          grid: { left: 60, right: 20, top: 50, bottom: 50 },
          xAxis: {
            type: "value",
            name: `市场收益率（${marketCode} %）`,
            nameLocation: "middle",
            nameGap: 30,
            axisLine: { lineStyle: { color: "#666" } },
            splitLine: { show: true, lineStyle: { type: "dashed" } }
          },
          yAxis: {
            type: "value",
            name: "个股收益率（%）",
            nameLocation: "middle",
            nameGap: 50,
            axisLine: { lineStyle: { color: "#666" } },
            splitLine: { show: true, lineStyle: { type: "dashed" } }
          },
          series: [
            {
              name: "散点",
              type: "scatter",
              symbolSize: function(data, params) {
                // 根据残差大小调整点的大小，残差越大点越大
                const marketRet = data[0];
                const stockRet = data[1];
                const predictedRet = alpha + beta * marketRet;
                const residual = Math.abs(stockRet - predictedRet);
                const size = 8 + (residual / maxResidual) * 12; // 8-20之间
                return size;
              },
              data: scatterData,
              itemStyle: {
                color: function(params) {
                  // 根据残差大小着色：残差大=红色，残差小=蓝色
                  const marketRet = params.data[0];
                  const stockRet = params.data[1];
                  const predictedRet = alpha + beta * marketRet;
                  const residual = Math.abs(stockRet - predictedRet);
                  const normalizedResidual = residual / maxResidual;
                  if (normalizedResidual > 0.7) return "#dc3545"; // 大残差（红色）
                  if (normalizedResidual > 0.4) return "#ffc107"; // 中等残差（黄色）
                  return "#0d6efd"; // 小残差（蓝色）
                },
                opacity: 0.7
              }
            },
            {
              name: "回归线",
              type: "line",
              data: regressionLine,
              lineStyle: {
                color: "#28a745",
                width: 2,
                type: "solid"
              },
              symbol: "none",
              smooth: false,
              tooltip: {
                show: true
              }
            }
          ],
          title: {
            show: true,
            text: `Beta = ${beta.toFixed(4)} | R² = ${rSquared.toFixed(4)}`,
            left: "center",
            top: 10,
            textStyle: {
              fontSize: 12,
              fontWeight: "bold"
            }
          }
        });
      }

      /**
       * 点击“开始分析”按钮时，将表单数据打包并通过 fetch 提交给后端
       */


      // 词云：选中的新闻ID列表和新闻数据缓存
      let selectedNewsIds = new Set();
      let wcNewsDataCache = []; // 缓存加载的新闻数据

      // 渲染新闻标题列表
      function renderWcNewsList(items) {
        // 保存到缓存
        wcNewsDataCache = items || [];
        const listBox = document.getElementById("wcNewsList");
        if (!listBox) return;
        listBox.innerHTML = "";
        
        if (!items || items.length === 0) {
          listBox.innerHTML = '<div class="text-muted text-center">暂无新闻数据</div>';
          return;
        }

        items.forEach((it, idx) => {
          const newsId = it.ts_id || `news-${idx}`;
          const isSelected = selectedNewsIds.has(newsId);
          const t = it.pub_time || "";
          const title = it.title || "(无标题)";
          const src = it.src || "";
          
          const div = document.createElement("div");
          div.className = `mb-2 p-2 border rounded ${isSelected ? "bg-primary text-white" : "bg-light"}`;
          div.style.cursor = "pointer";
          div.dataset.newsId = newsId;
          
          div.innerHTML = `
            <div class="d-flex align-items-start">
              <input type="checkbox" ${isSelected ? "checked" : ""} class="me-2 mt-1" style="pointer-events:none;">
              <div class="flex-grow-1">
                <div class="fw-bold">${htmlEscape(title)}</div>
                <div class="small ${isSelected ? "text-white-50" : "text-muted"}">
                  ${t ? `[${htmlEscape(t)}] ` : ""}${src ? `(${htmlEscape(src)})` : ""}
                </div>
              </div>
            </div>
          `;
          
          div.addEventListener("click", function() {
            if (selectedNewsIds.has(newsId)) {
              selectedNewsIds.delete(newsId);
            } else {
              selectedNewsIds.add(newsId);
            }
            renderWcNewsList(items); // 重新渲染以更新选中状态
            // 更新生成词云按钮状态
            document.getElementById("wcBtn").disabled = selectedNewsIds.size === 0;
          });
          
          listBox.appendChild(div);
        });
      }

      // 加载新闻列表
      document.getElementById("wcLoadBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "加载中...";
        
        const src = document.getElementById("wcSource").value || "sina";
        const keyword = document.getElementById("wcKeyword").value.trim();
        const limit = Number(document.getElementById("wcLimit").value || 50);
        
        document.getElementById("wcStatus").innerText = "正在加载新闻...";
        selectedNewsIds.clear(); // 清空之前的选择
        
        // 构建查询参数
        const params = new URLSearchParams();
        params.append("src", src);
        params.append("limit", limit.toString());
        if (keyword) params.append("keyword", keyword);
        
        // 使用今天的日期范围
        const today = new Date();
        const startDate = today.toISOString().slice(0, 10) + " 00:00:00";
        const endDate = today.toISOString().slice(0, 10) + " 23:59:59";
        params.append("start_date", startDate);
        params.append("end_date", endDate);
        
        fetch(`/api/ts_flash_viz?${params.toString()}`)
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "加载失败");
            }
            renderWcNewsList(d.items || []);
            document.getElementById("wcStatus").innerText = `加载完成：共 ${d.rows || 0} 条新闻${keyword ? `（关键词: ${keyword}）` : ""}`;
            document.getElementById("wcBtn").disabled = selectedNewsIds.size === 0;
          })
          .catch((e) => {
            document.getElementById("wcStatus").innerText = "加载失败：" + e.message;
            console.error("加载新闻失败:", e);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // 生成词云（基于选定的新闻）
      document.getElementById("wcBtn").addEventListener("click", function () {
        if (selectedNewsIds.size === 0) {
          alert("请先选择至少一条新闻");
          return;
        }
        
        // 从缓存中获取选定的新闻内容
        const selectedNews = wcNewsDataCache.filter(it => {
          const newsId = it.ts_id || `news-${wcNewsDataCache.indexOf(it)}`;
          return selectedNewsIds.has(newsId);
        });
        
        if (selectedNews.length === 0) {
          alert("未找到选定的新闻数据");
          return;
        }
        
        // 收集所有选定新闻的文本内容（标题+内容）
        const texts = [];
        selectedNews.forEach(it => {
          if (it.title) texts.push(String(it.title));
          if (it.content) texts.push(String(it.content));
        });
        
        if (texts.length === 0) {
          alert("选定的新闻没有文本内容");
          return;
        }
        
        // 显示加载状态
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "生成中...";
        document.getElementById("wcStatus").innerText = "正在生成词云...";
        
        // 调用词云API（文本数据会经过数据清洗）
        const fd = new FormData();
        fd.append("text_data", texts.join("\n"));
        
        fetch("/api/wordcloud", { method: "POST", body: fd })
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              }).catch(() => {
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "生成词云失败");
            }
            document.getElementById("wcStatus").innerText = 
              `词云生成完成（已选择 ${selectedNewsIds.size} 条新闻）`;
            renderWordCloud(d.words || []);
            // 确保图表在可见尺寸下渲染
            setTimeout(() => {
              wordChart.resize();
            }, 0);
          })
          .catch((e) => {
            const errorMsg = e.message || String(e);
            document.getElementById("wcStatus").innerText = "生成失败：" + errorMsg;
            console.error("词云生成错误:", e);
            alert("生成词云失败：" + errorMsg);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = originalText;
          });
      });


      // MySQL 机器学习预测（回归 / 分类 / 聚类）
      const mlBtn = document.getElementById("mlBtn");
      if (mlBtn) {
        mlBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "运行中...";

          const tableSel = document.getElementById("mlTable");
          const featSel = document.getElementById("mlFeatures");
          const targetSel = document.getElementById("mlTarget");
          const horizonInput = document.getElementById("mlHorizon");

          const tableName = tableSel ? tableSel.value : "";
          const featureCols = featSel
            ? Array.from(featSel.selectedOptions).map((o) => o.value)
            : [];
          const targetCol = targetSel ? (targetSel.value || "") : "";
          const horizon = horizonInput ? Number(horizonInput.value || 0) : 0;

          const fd = new FormData();
          fd.append("table_name", tableName || "financial_series");
          fd.append("feature_cols", featureCols.join(","));
          fd.append("target_col", targetCol);
          fd.append("horizon", String(horizon));

          fetch("/api/run_ml", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              const box = document.getElementById("mlResult");
              box.textContent = JSON.stringify(d, null, 2);

              const models = d.models || {};
              // 回归
              if (models.regression && !models.regression.error) {
                renderMlMetrics("mlChartReg", models.regression.metrics || {}, "回归指标");
              } else {
                renderMlMetrics("mlChartReg", {}, "回归指标");
              }
              // 分类
              if (models.classification && !models.classification.error) {
                renderMlMetrics("mlChartCls", models.classification.metrics || {}, "分类指标");
              } else {
                renderMlMetrics("mlChartCls", {}, "分类指标");
              }
              // 聚类
              if (models.clustering && !models.clustering.error) {
                renderMlMetrics("mlChartClu", models.clustering.metrics || {}, "聚类指标");
              } else {
                renderMlMetrics("mlChartClu", {}, "聚类指标");
              }

              // 时间序列预测（若后端返回）
              if (d.ts_forecast) {
                renderMlForecast(d.ts_forecast);
              } else {
                renderMlForecast(null);
              }
            })
            .catch((e) => {
              const box = document.getElementById("mlResult");
              box.textContent = "请求失败：" + e;
              renderMlMetrics("mlChartReg", {}, "回归指标");
              renderMlMetrics("mlChartCls", {}, "分类指标");
              renderMlMetrics("mlChartClu", {}, "聚类指标");
              renderMlForecast(null);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 预测类型切换：指数 / 股票 / 通用 ML
      function switchMlMode(mode) {
        const panelIndex = document.getElementById("mlPanelIndex");
        const panelStock = document.getElementById("mlPanelStock");
        const panelGeneric = document.getElementById("mlPanelGeneric");
        const genericCharts = document.getElementById("mlGenericCharts");

        if (!panelIndex || !panelStock || !panelGeneric || !genericCharts) return;

        panelIndex.style.display = mode === "index" ? "" : "none";
        panelStock.style.display = mode === "stock" ? "" : "none";
        panelGeneric.style.display = mode === "generic" ? "" : "none";

        // 通用 ML 指标图表只在 generic 模式下显示
        genericCharts.style.display = mode === "generic" ? "" : "none";
      }

      document.getElementById("mlModeIndex")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("index");
      });
      document.getElementById("mlModeStock")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("stock");
      });
      document.getElementById("mlModeGeneric")?.addEventListener("change", function () {
        if (this.checked) switchMlMode("generic");
      });

      // 默认模式：指数预测
      switchMlMode("index");

      // 单指数预测：调用 /api/ts_index_predict，结果画到统一 TS 图表（mlTsChart）上
      const indexPredBtn = document.getElementById("indexPredBtn");
      if (indexPredBtn) {
        indexPredBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "预测中...";

          const code = document.getElementById("indexPredCode").value;
          const horizon = Number(document.getElementById("indexPredHorizon").value || 8);

          const fd = new FormData();
          fd.append("ts_code", code);
          fd.append("horizon", String(horizon));

          fetch("/api/ts_index_predict", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              if (d.status === "error") {
                alert("指数预测失败：" + (d.msg || "未知错误"));
                return;
              }
              const hist = d.history || [];
              const fut = d.forecast || [];
              renderMlForecast({
                target_col: code,
                history: hist.map((p) => ({ y: p.value, date: p.date })),
                forecast: fut.map((p) => ({ y: p.value, date: p.date })),
              });
            })
            .catch((e) => {
              alert("指数预测请求失败：" + e);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 单只股票预测：调用 /api/ts_stock_predict，结果画到统一 TS 图表（mlTsChart）上
      const stockPredBtn = document.getElementById("stockPredBtn");
      if (stockPredBtn) {
        stockPredBtn.addEventListener("click", function () {
          const btn = this;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "预测中...";

          const code = document.getElementById("stockPredCode").value.trim();
          const horizon = Number(document.getElementById("stockPredHorizon").value || 8);
          if (!code) {
            alert("请先输入股票代码（ts_code）");
            btn.disabled = false;
            btn.textContent = original;
            return;
          }

          const fd = new FormData();
          fd.append("ts_code", code);
          fd.append("horizon", String(horizon));

          fetch("/api/ts_stock_predict", { method: "POST", body: fd })
            .then((r) => r.json())
            .then((d) => {
              if (d.status === "error") {
                alert("股票预测失败：" + (d.msg || "未知错误"));
                return;
              }
              const hist = d.history || [];
              const fut = d.forecast || [];
              renderMlForecast({
                target_col: code,
                history: hist.map((p) => ({ y: p.value, date: p.date })),
                forecast: fut.map((p) => ({ y: p.value, date: p.date })),
              });
            })
            .catch((e) => {
              alert("股票预测请求失败：" + e);
            })
            .finally(() => {
              btn.disabled = false;
              btn.textContent = original;
            });
        });
      }

      // 金融讯息可视化分析：TuShare 菁融短讯
      // 设置默认日期（今天）
      (function() {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 16);
        const startDateEl = document.getElementById("flashStartDate");
        const endDateEl = document.getElementById("flashEndDate");
        if (startDateEl && !startDateEl.value) {
          startDateEl.value = todayStr;
        }
        if (endDateEl && !endDateEl.value) {
          endDateEl.value = todayStr;
        }
      })();

      document.getElementById("flashBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        
        // 读取所有参数
        const startDateInput = document.getElementById("flashStartDate").value;
        const endDateInput = document.getElementById("flashEndDate").value;
        const src = document.getElementById("flashSrc").value || "sina";
        const keyword = document.getElementById("flashKeyword").value.trim();
        const limit = Number(document.getElementById("flashLimit").value || 80);
        
        // 转换日期格式：datetime-local (YYYY-MM-DDTHH:mm) -> TuShare 格式 (YYYY-MM-DD HH:mm:ss)
        let startDate = startDateInput ? startDateInput.replace("T", " ") + ":00" : "";
        let endDate = endDateInput ? endDateInput.replace("T", " ") + ":59" : "";
        
        btn.disabled = true;
        btn.textContent = "拉取中...";
        document.getElementById("flashStatus").innerText = `正在从 TuShare 拉取菁融短讯（优先 jrdc 接口，失败则用 news 接口）并生成词云/情感分析...`;

        // 构建查询参数
        const params = new URLSearchParams();
        if (startDate) params.append("start_date", startDate);
        if (endDate) params.append("end_date", endDate);
        params.append("src", src);
        params.append("limit", limit.toString());
        if (keyword) params.append("keyword", keyword);

        fetch(`/api/ts_flash_viz?${params.toString()}`)
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            document.getElementById("flashPreview").textContent = JSON.stringify(
              (d.items || []).slice(0, 30),
              null,
              2
            );
            // 列表展示：每条短讯 + 单条情感得分
            renderFlashList(d.items || []);
            updateFlashSentimentBar(d.sentiment || {});
            renderFlashSentimentChart(d.items || []); // 渲染情感比例饼图
            renderFlashWordCloud(d.words || []);
            // 调试：检查来源分布数据
            console.log("来源分布数据:", d.source_stats);
            renderFlashSourceChart(d.source_stats || []);
            renderFlashLenChart(d.length_buckets || []);
            document.getElementById("flashStatus").innerText = `完成：共 ${d.rows || 0} 条菁融短讯${keyword ? `（关键词: ${keyword}）` : ""}`;
            // 确保词云和饼图在可见尺寸下渲染
            setTimeout(() => {
              flashWordChart.resize();
              flashSentimentChart.resize();
              flashSourceChart.resize();
              flashLenChart.resize();
            }, 0);
          })
          .catch((e) => {
            document.getElementById("flashStatus").innerText = "失败：" + e.message;
            alert("菁融短讯拉取失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      function loadTsMarket() {
        const btn = document.getElementById("tsBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "拉取中...";
        }
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("tsBtn").addEventListener("click", loadTsMarket);

      // 货币报价
      function loadFx() {
        const btn = document.getElementById("fxBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "刷新中...";
        }
        fetch("/api/ts_fx")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderFxTable(d);
          })
          .catch((e) => {
            alert("货币数据拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("fxBtn").addEventListener("click", loadFx);

      // 单股区间涨幅
      document.getElementById("stockBtn").addEventListener("click", function () {
        const code = document.getElementById("stockCode").value.trim();
        const start = document.getElementById("stockStart").value.trim();
        const end = document.getElementById("stockEnd").value.trim();
        if (!code || !start || !end) {
          alert("请完整填写股票代码和起止日期");
          return;
        }
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "查询中...";
        const fd = new FormData();
        fd.append("ts_code", code);
        fd.append("start_date", start);
        fd.append("end_date", end);
        fetch("/api/ts_stock_range", { method: "POST", body: fd })
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "查询失败");
            }
            renderStockRange(d.dates || [], d.cum_change || [], d.ts_code);
            // 渲染因子模型与回归分析散点图
            if (d.factor_model) {
              renderStockFactorModel(d.factor_model, d.ts_code);
            }
          })
          .catch((e) => {
            alert("区间涨幅查询失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      document.getElementById("tsBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "拉取中...";
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });


      // 自适应窗口尺寸
      window.addEventListener("resize", function () {
        wordChart.resize();
        predictChart.resize();
      });
    </script>
  </body>
</html>



