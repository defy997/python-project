<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>金融数据与文献综合分析系统</title>
    <!-- 引入 Bootstrap 与 ECharts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <style>
      body {
        background-color: #f5f7fa;
      }
      .page-title {
        font-weight: 600;
        letter-spacing: 0.08em;
      }
      .chart-card {
        background: #fff;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(15, 35, 52, 0.08);
        height: 360px;
      }
      .chart-box {
        width: 100%;
        height: 100%;
      }
      .section-title {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .summary-box {
        white-space: pre-wrap;
        background: #fff;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid #0d6efd;
        font-size: 0.95rem;
      }
      .sentiment-bar {
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
      }
      .sentiment-seg {
        height: 100%;
      }
      .sentiment-pos {
        background: #4caf50;
      }
      .sentiment-neu {
        background: #ffc107;
      }
      .sentiment-neg {
        background: #f44336;
      }
    </style>
  </head>

  <body>
    <div class="container py-3">
      <div class="mb-3 text-center">
        <h2 class="page-title">金融数据与文献综合分析系统</h2>
        <p class="text-muted small mb-1">
          通过前后端交互，对金融数据进行多维度可视化分析，并借助“AI 模型”进行文献摘要与情感分析。
        </p>
        <p class="text-muted small">
          如需进行“爬虫 + MySQL + 机器学习”实验，请点击
          <a href="/crawler_ml" class="link-primary">这里进入综合爬虫页面</a>（同一后端程序）。
        </p>
      </div>

      <!-- 输入区域：数据与文本 -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">一、金融数据输入</div>
              <div class="mb-2 small text-muted">
                支持三种方式：1）上传 CSV 文件；2）在下方文本框粘贴表格数据；3）使用示例内置数据集。
              </div>

              <div class="mb-3">
                <label class="form-label">1）上传 CSV 文件</label>
                <input
                  type="file"
                  class="form-control"
                  id="fileInput"
                  accept=".csv"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">2）粘贴 CSV 文本</label>
                <textarea
                  class="form-control"
                  id="textData"
                  rows="4"
                  placeholder="在此粘贴以逗号分隔的表格数据（首行为列名）"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">3）使用内置示例数据集</label>
                <select class="form-select" id="datasetSelect">
                  <option value="ads" selected>广告投放与销售数据（advertising.csv）</option>
                  <option value="trade">股票交易数据（trade.csv）</option>
                </select>
              </div>

              <div class="row g-2">
                <div class="col">
                  <label class="form-label">X 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="xCol"
                    placeholder="例如：TV / Open"
                  />
                </div>
                <div class="col">
                  <label class="form-label">Y 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="yCol"
                    placeholder="例如：Sales / Close"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <div class="section-title">二、金融文献 / 新闻文本</div>
              <div class="mb-2 small text-muted">
                将金融研究报告、新闻或公告粘贴在此，系统将调用“AI 模型”生成摘要并进行情感分析（示例实现）。
              </div>
              <textarea
                class="form-control mb-3 flex-grow-1"
                id="docText"
                rows="6"
                placeholder="在此粘贴金融文本，例如一段关于某只股票的研究报告或市场新闻……"
              ></textarea>

              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" id="analyzeBtn">
                  开始分析
                </button>
                <span class="small text-muted" id="statusText"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 数值分析与 AI 文本分析结果 -->
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">
                三、数值分析摘要
                <small class="text-muted" id="xyLabel"></small>
              </div>
              <div id="summaryBox" class="summary-box small">
                点击“开始分析”后，这里将展示基于金融数据的简要分析结论。
              </div>
              <div class="mt-2 small text-muted" id="savedFiles"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="section-title">四、AI 文本摘要与情感分析</div>
              <div
                id="aiSummary"
                class="summary-box small mb-2"
                style="min-height: 80px"
              >
                若输入了金融文本，这里将给出“AI 模型”生成的摘要示例。
              </div>
              <div class="small text-muted mb-1">情感分布：</div>
              <div class="sentiment-bar mb-1">
                <div
                  id="sentPos"
                  class="sentiment-seg sentiment-pos"
                  style="width: 33%"
                ></div>
                <div
                  id="sentNeu"
                  class="sentiment-seg sentiment-neu"
                  style="width: 34%"
                ></div>
                <div
                  id="sentNeg"
                  class="sentiment-seg sentiment-neg"
                  style="width: 33%"
                ></div>
              </div>
              <div class="small">
                <span class="text-success">正向：</span
                ><span id="sentPosText">33%</span>，
                <span class="text-warning">中性：</span
                ><span id="sentNeuText">34%</span>，
                <span class="text-danger">负向：</span
                ><span id="sentNegText">33%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 五类及以上图形展示 -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="section-title mb-2">五、多维度图形可视化（不少于 5 类）</div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartLine" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">折线图：收益趋势</div>
            </div>
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartBar" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">柱状图：收益对比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartPie" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">饼图：收益区间占比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartScatter" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">散点图：单期收益散点分布</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartBox" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">箱线图：整体收益分布</div>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center text-muted small py-2">
        课程实验示例 &copy; 金融数据分析与 AI 应用
      </footer>
    </div>

    <script>
      // 初始化五个 ECharts 图表实例
      const chartLine = echarts.init(document.getElementById("chartLine"));
      const chartBar = echarts.init(document.getElementById("chartBar"));
      const chartPie = echarts.init(document.getElementById("chartPie"));
      const chartScatter = echarts.init(document.getElementById("chartScatter"));
      const chartBox = echarts.init(document.getElementById("chartBox"));

      // 设置空白初始配置
      chartLine.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBar.setOption({ title: { text: "等待数据...", left: "center" } });
      chartPie.setOption({ title: { text: "等待数据...", left: "center" } });
      chartScatter.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBox.setOption({ title: { text: "等待数据...", left: "center" } });

      /**
       * 辅助函数：更新情感条与文本
       */
      function updateSentimentBar(sentiment) {
        const p = Math.round((sentiment.positive || 0) * 100);
        const n = Math.round((sentiment.neutral || 0) * 100);
        const g = Math.round((sentiment.negative || 0) * 100);
        document.getElementById("sentPos").style.width = p + "%";
        document.getElementById("sentNeu").style.width = n + "%";
        document.getElementById("sentNeg").style.width = g + "%";
        document.getElementById("sentPosText").innerText = p + "%";
        document.getElementById("sentNeuText").innerText = n + "%";
        document.getElementById("sentNegText").innerText = g + "%";
      }

      /**
       * 辅助函数：根据后端返回数据更新所有图表
       */
      function updateCharts(payload) {
        const charts = payload.charts || {};
        const x = charts.line?.x || [];
        const y = charts.line?.y || [];

        // 折线图
        chartLine.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: x },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: y,
            },
          ],
        });

        // 柱状图
        chartBar.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: charts.bar?.x || [] },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "bar",
              data: charts.bar?.y || [],
              itemStyle: { color: "#0d6efd" },
            },
          ],
        });

        // 饼图
        chartPie.setOption({
          tooltip: { trigger: "item" },
          legend: { top: "bottom" },
          series: [
            {
              name: "收益区间",
              type: "pie",
              radius: "65%",
              data: charts.pie || [],
            },
          ],
        });

        // 散点图
        const scatterX = charts.scatter?.x || [];
        const scatterY = charts.scatter?.y || [];
        const scatterData = scatterX.map((v, i) => [v, scatterY[i]]);
        chartScatter.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "value", name: "期数" },
          yAxis: { type: "value", name: payload.y_col },
          series: [
            {
              name: "单期收益",
              type: "scatter",
              symbolSize: 8,
              data: scatterData,
            },
          ],
        });

        // 箱线图
        const box = charts.boxplot?.data || [];
        chartBox.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "category", data: [payload.y_col] },
          yAxis: { type: "value" },
          series: [
            {
              name: "收益分布",
              type: "boxplot",
              data: [box],
            },
          ],
        });
      }

      /**
       * 点击“开始分析”按钮时，将表单数据打包并通过 fetch 提交给后端
       */
      document
        .getElementById("analyzeBtn")
        .addEventListener("click", function () {
          const formData = new FormData();

          // 数据部分
          const file = document.getElementById("fileInput").files[0];
          if (file) {
            formData.append("file", file);
          }
          formData.append(
            "text_data",
            document.getElementById("textData").value
          );
          formData.append(
            "dataset",
            document.getElementById("datasetSelect").value
          );
          formData.append("x_col", document.getElementById("xCol").value);
          formData.append("y_col", document.getElementById("yCol").value);

          // 文本与 AI 分析部分
          formData.append("doc_text", document.getElementById("docText").value);

          document.getElementById("statusText").innerText = "正在分析，请稍候…";

          fetch("/analyze", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("statusText").innerText = "分析完成";

              // 更新数值摘要
              document.getElementById("xyLabel").innerText =
                "(X 轴：" + data.x_col + "，Y 轴：" + data.y_col + ")";
              document.getElementById("summaryBox").innerText =
                data.summary || "未获得有效的统计摘要，请检查数据。";

              // 更新 AI 摘要
              document.getElementById("aiSummary").innerText =
                data.ai_summary ||
                "未输入金融文本，暂无法给出 AI 摘要示例。";

              // 更新情感条
              updateSentimentBar(data.sentiment || {});

              // 更新输出文件列表
              const files = data.files || [];
              const span = document.getElementById("savedFiles");
              if (files.length > 0) {
                span.innerHTML =
                  "分析结果文件已保存在后端，可通过以下链接下载：" +
                  files
                    .map((p) => {
                      const name = p.split(/[\\/]/).slice(-1)[0];
                      return (
                        '<a href="/files/' +
                        name +
                        '" target="_blank" class="me-2">' +
                        name +
                        "</a>"
                      );
                    })
                    .join("");
              } else {
                span.innerHTML = "";
              }

              // 更新五类图表
              updateCharts(data);
            })
            .catch((err) => {
              console.error(err);
              document.getElementById("statusText").innerText =
                "分析失败，请查看控制台。";
            });
        });

      // 自适应窗口尺寸
      window.addEventListener("resize", function () {
        chartLine.resize();
        chartBar.resize();
        chartPie.resize();
        chartScatter.resize();
        chartBox.resize();
      });
    </script>
  </body>
</html>


