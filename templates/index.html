<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>金融数据与文献综合分析系统</title>
    <!-- 引入 Bootstrap 与 ECharts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
      body {
        background-color: #f5f7fa;
      }
      .page-title {
        font-weight: 600;
        letter-spacing: 0.08em;
      }
      .chart-card {
        background: #fff;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(15, 35, 52, 0.08);
        height: 360px;
      }
      .chart-box {
        width: 100%;
        height: 100%;
      }
      .section-title {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .summary-box {
        white-space: pre-wrap;
        background: #fff;
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 4px solid #0d6efd;
        font-size: 0.95rem;
      }
      .sentiment-bar {
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
      }
      .sentiment-seg {
        height: 100%;
      }
      .sentiment-pos {
        background: #4caf50;
      }
      .sentiment-neu {
        background: #ffc107;
      }
      .sentiment-neg {
        background: #f44336;
      }
      /* 分页内容容器：默认隐藏，激活时显示 */
      .section-block {
        display: none;
      }
      .section-block.active {
        display: block;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid py-3">
      <div class="mb-3 text-center">
        <h2 class="page-title">金融数据与文献综合分析系统</h2>
        <p class="text-muted small mb-1">
          通过前后端交互，对金融数据进行多维度可视化分析，并借助“AI 模型”进行文献摘要与情感分析。
        </p>
        <p class="text-muted small">
          如需进行“爬虫 + MySQL + 机器学习”实验，请点击
          <a href="/crawler_ml" class="link-primary">这里进入综合爬虫页面</a>（同一后端程序）。
        </p>
      </div>

      <!-- 布局：左侧侧边栏 + 右侧分页内容 -->
      <div class="row">
        <div class="col-md-2 col-lg-2 mb-3">
          <div class="list-group shadow-sm" id="sideNav">
            <a class="list-group-item list-group-item-action" data-target="section-crawler" href="#">爬虫取数</a>
            <a class="list-group-item list-group-item-action" data-target="section-wordcloud" href="#">词云</a>
            <a class="list-group-item list-group-item-action" data-target="section-sentiment" href="#">评分系统</a>
            <a class="list-group-item list-group-item-action" data-target="section-predict" href="#">股票预测</a>
            <a class="list-group-item list-group-item-action" data-target="section-analysis" href="#">数据分析</a>
          </div>
        </div>

        <!-- 右侧主体内容（分页切换） -->
        <div class="col-md-10 col-lg-10">

        <!-- 爬虫与数据获取 -->
        <div class="card shadow-sm mb-3 section-block" id="section-crawler">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">一、爬虫获取金融新闻并入库</div>
              <small class="text-muted">外网可用时将尝试实时抓取，失败自动回退示例数据</small>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">新闻关键字</label>
                <input id="crawlKeyword" class="form-control" placeholder="例如：利率 / 中概股" />
              </div>
              <div class="col-md-4">
                <label class="form-label">保存到 MySQL 表名</label>
                <input id="crawlTable" class="form-control" value="news_data" />
              </div>
              <div class="col-md-4">
                <button class="btn btn-success w-100" id="crawlBtn">抓取并保存</button>
              </div>
            </div>
            <pre class="bg-dark text-light p-2 small mt-2" style="max-height:180px;overflow:auto" id="crawlPreview"></pre>
          </div>
        </div>

        <!-- 词云 -->
        <div class="card shadow-sm mb-3 section-block" id="section-wordcloud">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">二、词云可视化</div>
              <small class="text-muted">数据源：爬虫表 / 上传 CSV / 文本框</small>
            </div>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">MySQL 表名（可选）</label>
                <input id="wcTable" class="form-control" placeholder="如：news_data" />
              </div>
              <div class="col-md-3">
                <label class="form-label">上传 CSV（第一列为文本）</label>
                <input id="wcFile" type="file" accept=".csv" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">或直接粘贴文本</label>
                <textarea id="wcText" rows="2" class="form-control" placeholder="多段文本可换行"></textarea>
              </div>
            </div>
            <div class="mt-2 d-flex align-items-center gap-2">
              <button class="btn btn-primary" id="wcBtn">生成词云</button>
              <small class="text-muted" id="wcSource"></small>
            </div>
            <div id="wordCloud" style="height:300px" class="mt-2"></div>
          </div>
        </div>

        <!-- 评分系统 -->
        <div class="card shadow-sm mb-3 section-block" id="section-sentiment">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">三、情感/热度/风险评分</div>
              <small class="text-muted">复用爬虫数据或自定义文本</small>
            </div>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">MySQL 表名（可选）</label>
                <input id="sentTable" class="form-control" placeholder="如：news_data" />
              </div>
              <div class="col-md-3">
                <label class="form-label">上传 CSV</label>
                <input id="sentFile" type="file" accept=".csv" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">粘贴文本</label>
                <textarea id="sentText" rows="2" class="form-control" placeholder="情绪文本，可多行"></textarea>
              </div>
            </div>
            <div class="mt-2">
              <button class="btn btn-warning" id="sentBtn">计算评分</button>
              <span class="text-muted small ms-2" id="sentSource"></span>
            </div>
            <div class="mt-2 small">
              <div>情感：<span id="sentPosText2" class="text-success">-</span> / <span id="sentNeuText2" class="text-secondary">-</span> / <span id="sentNegText2" class="text-danger">-</span></div>
              <div>热度：<span id="sentHeat">-</span>，风险评分：<span id="sentRisk">-</span></div>
            </div>
          </div>
        </div>

        <!-- 股票预测 / TuShare 多指数 -->
        <div class="card shadow-sm mb-3 section-block" id="section-predict">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title mb-0">四、TuShare 多指数行情与预测</div>
              <small class="text-muted">拉取上证/深成/创业/沪深300/中证500 等指数，自动绘制多折线</small>
            </div>

            <div class="row g-2 align-items-end mb-2">
              <div class="col-md-4">
                <button class="btn btn-success w-100" id="tsBtn">拉取 TuShare 指数行情</button>
              </div>
              <div class="col-md-4">
                <label class="form-label">可选：自定义价格接口（返回 data 数组）</label>
                <input id="predApi" class="form-control" placeholder="http(s)://..." />
              </div>
              <div class="col-md-2">
                <label class="form-label">预测步数</label>
                <input id="predHorizon" type="number" min="3" max="30" value="8" class="form-control" />
              </div>
              <div class="col-md-2">
                <button class="btn btn-info w-100" id="predBtn">生成预测</button>
              </div>
            </div>

            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">多指数走势</div>
                <div id="predictChart" style="height:320px"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">最新报价</div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0" id="tsTable">
                    <thead>
                      <tr>
                        <th>指数</th>
                        <th>最新价</th>
                        <th>涨跌幅</th>
                        <th>日期</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 货币板块 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="section-title mb-0" style="font-size: 0.95rem;">货币（相对美元）</div>
                  <button class="btn btn-outline-secondary btn-sm" id="fxBtn">刷新货币报价</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0" id="fxTable">
                    <thead>
                      <tr>
                        <th>货币</th>
                        <th>符号</th>
                        <th>价格</th>
                        <th>涨跌额</th>
                        <th>涨跌幅</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 单只股票区间涨幅 -->
            <div class="card mt-3">
              <div class="card-body p-2">
                <div class="section-title mb-2" style="font-size: 0.95rem;">单只股票区间涨幅分析</div>
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">股票代码（ts_code）</label>
                    <input id="stockCode" class="form-control" placeholder="如：600519.SH" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">开始日期</label>
                    <input id="stockStart" class="form-control" placeholder="如：20250101" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">结束日期</label>
                    <input id="stockEnd" class="form-control" placeholder="如：20251231" />
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="stockBtn">查询涨幅</button>
                  </div>
                </div>
                <div id="stockChart" style="height:260px" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>

      <!-- 数据分析分页容器 -->
      <div class="section-block" id="section-analysis">
      <!-- 输入区域：数据与文本 -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">一、金融数据输入</div>
              <div class="mb-2 small text-muted">
                支持三种方式：1）上传 CSV 文件；2）在下方文本框粘贴表格数据；3）使用示例内置数据集。
              </div>

              <div class="mb-3">
                <label class="form-label">1）上传 CSV 文件</label>
                <input
                  type="file"
                  class="form-control"
                  id="fileInput"
                  accept=".csv"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">2）粘贴 CSV 文本</label>
                <textarea
                  class="form-control"
                  id="textData"
                  rows="4"
                  placeholder="在此粘贴以逗号分隔的表格数据（首行为列名）"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">3）使用内置示例数据集</label>
                <select class="form-select" id="datasetSelect">
                  <option value="ads" selected>广告投放与销售数据（advertising.csv）</option>
                  <option value="trade">股票交易数据（trade.csv）</option>
                </select>
              </div>

              <div class="row g-2">
                <div class="col">
                  <label class="form-label">X 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="xCol"
                    placeholder="例如：TV / Open"
                  />
                </div>
                <div class="col">
                  <label class="form-label">Y 轴列名（可留空自动推断）</label>
                  <input
                    type="text"
                    class="form-control"
                    id="yCol"
                    placeholder="例如：Sales / Close"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <div class="section-title">二、金融文献 / 新闻文本</div>
              <div class="mb-2 small text-muted">
                将金融研究报告、新闻或公告粘贴在此，系统将调用“AI 模型”生成摘要并进行情感分析（示例实现）。
              </div>
              <textarea
                class="form-control mb-3 flex-grow-1"
                id="docText"
                rows="6"
                placeholder="在此粘贴金融文本，例如一段关于某只股票的研究报告或市场新闻……"
              ></textarea>

              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" id="analyzeBtn">
                  开始分析
                </button>
                <span class="small text-muted" id="statusText"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 数值分析与 AI 文本分析结果 -->
      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section-title">
                三、数值分析摘要
                <small class="text-muted" id="xyLabel"></small>
              </div>
              <div id="summaryBox" class="summary-box small">
                点击“开始分析”后，这里将展示基于金融数据的简要分析结论。
              </div>
              <div class="mt-2 small text-muted" id="savedFiles"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="section-title">四、AI 文本摘要与情感分析</div>
              <div
                id="aiSummary"
                class="summary-box small mb-2"
                style="min-height: 80px"
              >
                若输入了金融文本，这里将给出“AI 模型”生成的摘要示例。
              </div>
              <div class="small text-muted mb-1">情感分布：</div>
              <div class="sentiment-bar mb-1">
                <div
                  id="sentPos"
                  class="sentiment-seg sentiment-pos"
                  style="width: 33%"
                ></div>
                <div
                  id="sentNeu"
                  class="sentiment-seg sentiment-neu"
                  style="width: 34%"
                ></div>
                <div
                  id="sentNeg"
                  class="sentiment-seg sentiment-neg"
                  style="width: 33%"
                ></div>
              </div>
              <div class="small">
                <span class="text-success">正向：</span
                ><span id="sentPosText">33%</span>，
                <span class="text-warning">中性：</span
                ><span id="sentNeuText">34%</span>，
                <span class="text-danger">负向：</span
                ><span id="sentNegText">33%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 五类及以上图形展示 -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="section-title mb-2">五、多维度图形可视化（不少于 5 类）</div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartLine" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">折线图：收益趋势</div>
            </div>
            <div class="col-md-6">
              <div class="chart-card">
                <div id="chartBar" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">柱状图：收益对比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartPie" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">饼图：收益区间占比</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartScatter" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">散点图：单期收益散点分布</div>
            </div>
            <div class="col-md-4">
              <div class="chart-card">
                <div id="chartBox" class="chart-box"></div>
              </div>
              <div class="small text-muted mt-1 text-center">箱线图：整体收益分布</div>
            </div>
          </div>
        </div>
      </div>

        </div> <!-- /section-analysis -->
        </div> <!-- /右侧主体 -->
      </div> <!-- /row -->

      <footer class="text-center text-muted small py-2">
        课程实验示例 &copy; 金融数据分析与 AI 应用
      </footer>
    </div>

    <script>
      // 初始化图表实例
      const chartLine = echarts.init(document.getElementById("chartLine"));
      const chartBar = echarts.init(document.getElementById("chartBar"));
      const chartPie = echarts.init(document.getElementById("chartPie"));
      const chartScatter = echarts.init(document.getElementById("chartScatter"));
      const chartBox = echarts.init(document.getElementById("chartBox"));
      const wordChart = echarts.init(document.getElementById("wordCloud"));
      const predictChart = echarts.init(
        document.getElementById("predictChart")
      );

      // 侧边栏分页切换
      const sectionBlocks = document.querySelectorAll(".section-block");
      const sideLinks = document.querySelectorAll("#sideNav a[data-target]");
      let predictLoaded = false;

      function showSection(id) {
        sectionBlocks.forEach((sec) => {
          sec.classList.toggle("active", sec.id === id);
        });
        sideLinks.forEach((link) => {
          link.classList.toggle("active", link.dataset.target === id);
        });

        // 首次切换到“股票预测”分页时自动获取指数与货币数据
        if (id === "section-predict" && !predictLoaded) {
          if (typeof loadTsMarket === "function") {
            loadTsMarket();
          }
          if (typeof loadFx === "function") {
            loadFx();
          }
          predictLoaded = true;
        }
      }

      sideLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          showSection(this.dataset.target);
        });
      });

      // 默认显示第一个分页
      if (sideLinks.length > 0) {
        showSection(sideLinks[0].dataset.target);
      }

      // 设置空白初始配置
      chartLine.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBar.setOption({ title: { text: "等待数据...", left: "center" } });
      chartPie.setOption({ title: { text: "等待数据...", left: "center" } });
      chartScatter.setOption({ title: { text: "等待数据...", left: "center" } });
      chartBox.setOption({ title: { text: "等待数据...", left: "center" } });
      wordChart.setOption({ title: { text: "等待数据...", left: "center" } });
      predictChart.setOption({ title: { text: "等待数据...", left: "center" } });

      /**
       * 辅助函数：更新情感条与文本
       */
      function updateSentimentBar(sentiment) {
        const p = Math.round((sentiment.positive || 0) * 100);
        const n = Math.round((sentiment.neutral || 0) * 100);
        const g = Math.round((sentiment.negative || 0) * 100);
        document.getElementById("sentPos").style.width = p + "%";
        document.getElementById("sentNeu").style.width = n + "%";
        document.getElementById("sentNeg").style.width = g + "%";
        document.getElementById("sentPosText").innerText = p + "%";
        document.getElementById("sentNeuText").innerText = n + "%";
        document.getElementById("sentNegText").innerText = g + "%";
      }

      /**
       * 辅助函数：根据后端返回数据更新所有图表
       */
      function updateCharts(payload) {
        const charts = payload.charts || {};
        const x = charts.line?.x || [];
        const y = charts.line?.y || [];

        // 折线图
        chartLine.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: x },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: y,
            },
          ],
        });

        // 柱状图
        chartBar.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: charts.bar?.x || [] },
          yAxis: { type: "value" },
          series: [
            {
              name: payload.y_col,
              type: "bar",
              data: charts.bar?.y || [],
              itemStyle: { color: "#0d6efd" },
            },
          ],
        });

        // 饼图
        chartPie.setOption({
          tooltip: { trigger: "item" },
          legend: { top: "bottom" },
          series: [
            {
              name: "收益区间",
              type: "pie",
              radius: "65%",
              data: charts.pie || [],
            },
          ],
        });

        // 散点图
        const scatterX = charts.scatter?.x || [];
        const scatterY = charts.scatter?.y || [];
        const scatterData = scatterX.map((v, i) => [v, scatterY[i]]);
        chartScatter.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "value", name: "期数" },
          yAxis: { type: "value", name: payload.y_col },
          series: [
            {
              name: "单期收益",
              type: "scatter",
              symbolSize: 8,
              data: scatterData,
            },
          ],
        });

        // 箱线图
        const box = charts.boxplot?.data || [];
        chartBox.setOption({
          tooltip: { trigger: "item" },
          xAxis: { type: "category", data: [payload.y_col] },
          yAxis: { type: "value" },
          series: [
            {
              name: "收益分布",
              type: "boxplot",
              data: [box],
            },
          ],
        });
      }

      /**
       * 词云渲染
       */
      function renderWordCloud(words) {
        wordChart.setOption({
          tooltip: {},
          series: [
            {
              type: "wordCloud",
              shape: "circle",
              sizeRange: [12, 42],
              rotationRange: [-45, 45],
              gridSize: 6,
              textStyle: {
                color: () =>
                  "rgb(" +
                  [
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                  ].join(",") +
                  ")",
              },
              data: words,
            },
          ],
        });
      }

      /**
       * 股票预测渲染
       */
      function renderPredict(history, forecast, yCol) {
        const histData = history.map((d) => [d.x, d.y]);
        const futData = forecast.map((d) => [d.x, d.y]);
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "value" },
          yAxis: { type: "value", name: yCol || "price" },
          series: [
            {
              name: "历史",
              type: "line",
              data: histData,
              smooth: true,
              symbol: "circle",
            },
            {
              name: "预测",
              type: "line",
              data: futData,
              smooth: true,
              lineStyle: { type: "dashed" },
              symbol: "triangle",
            },
          ],
        });
      }

      /**
       * TuShare 指数行情渲染
       */
      function renderTsMarket(data) {
        const x = (data.x || []).map((d) => d);
        const series = data.series || [];
        predictChart.setOption({
          tooltip: { trigger: "axis" },
          legend: {
            top: 10,
            type: "scroll", // 当图例较多时可横向滚动
            orient: "horizontal",
            itemGap: 18,
            textStyle: {
              fontSize: 12,
            },
          },
          xAxis: {
            type: "category",
            data: x,
          },
          yAxis: { type: "value", name: "指数点位" },
          series,
        });

        // 填充表格
        const tbody = document.querySelector("#tsTable tbody");
        tbody.innerHTML = "";
        (data.latest || []).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}%</td>
            <td>${row.date}</td>
          `;
          tbody.appendChild(tr);
        });

        // 如果存在缺失的指数，给出提示
        if (data.missing && data.missing.length > 0) {
          const msg = "以下指数未能从 TuShare 拉取，使用占位数据：" + data.missing.join("、");
          predictChart.setOption({
            title: { text: msg, left: "center", textStyle: { fontSize: 12 } },
          });
        } else {
          predictChart.setOption({ title: { text: "" } });
        }
      }

      /**
       * 货币表渲染
       */
      function renderFxTable(data) {
        const tbody = document.querySelector("#fxTable tbody");
        tbody.innerHTML = "";
        (data.currencies || []).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.symbol}</td>
            <td>${row.price}</td>
            <td class="${row.chg >= 0 ? "text-success" : "text-danger"}">${row.chg}</td>
            <td class="${row.pct >= 0 ? "text-success" : "text-danger"}">${row.pct}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      /**
       * 单股区间涨幅图渲染
       */
      function renderStockRange(dates, cumChange, code) {
        const dom = document.getElementById("stockChart");
        const stockChart = echarts.init(dom);
        stockChart.setOption({
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: dates },
          yAxis: { type: "value", name: "累计涨幅(%)" },
          series: [
            {
              name: code,
              type: "line",
              smooth: true,
              areaStyle: {},
              data: cumChange,
            },
          ],
        });
      }

      /**
       * 点击“开始分析”按钮时，将表单数据打包并通过 fetch 提交给后端
       */

      // 爬虫按钮
      document.getElementById("crawlBtn").addEventListener("click", function () {
        const fd = new FormData();
        fd.append("keyword", document.getElementById("crawlKeyword").value);
        fd.append("table_name", document.getElementById("crawlTable").value);
        fetch("/api/crawl_news_v2", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("crawlPreview").textContent = JSON.stringify(
              d,
              null,
              2
            );
          })
          .catch((e) => {
            document.getElementById("crawlPreview").textContent =
              "请求失败：" + e;
          });
      });

      // 词云
      document.getElementById("wcBtn").addEventListener("click", function () {
        const fd = new FormData();
        const file = document.getElementById("wcFile").files[0];
        if (file) fd.append("file", file);
        fd.append("text_data", document.getElementById("wcText").value);
        fd.append("table_name", document.getElementById("wcTable").value);
        fetch("/api/wordcloud", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("wcSource").innerText =
              "数据源：" + (d.source || "未知");
            renderWordCloud(d.words || []);
          })
          .catch((e) => {
            document.getElementById("wcSource").innerText = "请求失败：" + e;
          });
      });

      // 评分系统
      document.getElementById("sentBtn").addEventListener("click", function () {
        const fd = new FormData();
        const file = document.getElementById("sentFile").files[0];
        if (file) fd.append("file", file);
        fd.append("text_data", document.getElementById("sentText").value);
        fd.append("table_name", document.getElementById("sentTable").value);
        fetch("/api/sentiment_score", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            document.getElementById("sentSource").innerText =
              "数据源：" + (d.source || "未知");
            const s = d.sentiment || {};
            const p = Math.round((s.positive || 0) * 100);
            const n = Math.round((s.neutral || 0) * 100);
            const g = Math.round((s.negative || 0) * 100);
            document.getElementById("sentPosText2").innerText = `正向 ${p}%`;
            document.getElementById("sentNeuText2").innerText = `中性 ${n}%`;
            document.getElementById("sentNegText2").innerText = `负向 ${g}%`;
            document.getElementById("sentHeat").innerText = `热度 ${(d.heat || 0).toFixed(2)}`;
            document.getElementById("sentRisk").innerText = d.risk ?? "-";
            // 同时更新顶部情感条便于复用
            updateSentimentBar(s);
          })
          .catch((e) => {
            document.getElementById("sentSource").innerText = "请求失败：" + e;
          });
      });

      // 股票预测
      document.getElementById("predBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "预测中...";
        const fd = new FormData();
        fd.append("api_url", document.getElementById("predApi").value);
        fd.append("horizon", document.getElementById("predHorizon").value);
        fetch("/api/stock_predict", { method: "POST", body: fd })
          .then((r) => r.json())
          .then((d) => {
            if (d.status === "ok") {
              renderPredict(d.history || [], d.forecast || [], d.y_col);
            } else {
              predictChart.setOption({
                title: { text: d.msg || "预测失败", left: "center" },
              });
            }
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "请求失败：" + e, left: "center" },
            });
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      function loadTsMarket() {
        const btn = document.getElementById("tsBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "拉取中...";
        }
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("tsBtn").addEventListener("click", loadTsMarket);

      // 货币报价
      function loadFx() {
        const btn = document.getElementById("fxBtn");
        const original = btn ? btn.textContent : "";
        if (btn) {
          btn.disabled = true;
          btn.textContent = "刷新中...";
        }
        fetch("/api/ts_fx")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderFxTable(d);
          })
          .catch((e) => {
            alert("货币数据拉取失败：" + e.message);
          })
          .finally(() => {
            if (btn) {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
      }

      document.getElementById("fxBtn").addEventListener("click", loadFx);

      // 单股区间涨幅
      document.getElementById("stockBtn").addEventListener("click", function () {
        const code = document.getElementById("stockCode").value.trim();
        const start = document.getElementById("stockStart").value.trim();
        const end = document.getElementById("stockEnd").value.trim();
        if (!code || !start || !end) {
          alert("请完整填写股票代码和起止日期");
          return;
        }
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "查询中...";
        const fd = new FormData();
        fd.append("ts_code", code);
        fd.append("start_date", start);
        fd.append("end_date", end);
        fetch("/api/ts_stock_range", { method: "POST", body: fd })
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "查询失败");
            }
            renderStockRange(d.dates || [], d.cum_change || [], d.ts_code);
          })
          .catch((e) => {
            alert("区间涨幅查询失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      // TuShare 多指数行情
      document.getElementById("tsBtn").addEventListener("click", function () {
        const btn = this;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = "拉取中...";
        fetch("/api/ts_market")
          .then((r) => {
            if (!r.ok) {
              return r.json().then((d) => {
                throw new Error(d.msg || `HTTP ${r.status}`);
              });
            }
            return r.json();
          })
          .then((d) => {
            if (d.status === "error") {
              throw new Error(d.msg || "拉取失败");
            }
            renderTsMarket(d);
          })
          .catch((e) => {
            predictChart.setOption({
              title: { text: "TuShare 拉取失败：" + e.message, left: "center" },
            });
            alert("TuShare 拉取失败：" + e.message);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = original;
          });
      });

      document
        .getElementById("analyzeBtn")
        .addEventListener("click", function () {
          const formData = new FormData();

          // 数据部分
          const file = document.getElementById("fileInput").files[0];
          if (file) {
            formData.append("file", file);
          }
          formData.append(
            "text_data",
            document.getElementById("textData").value
          );
          formData.append(
            "dataset",
            document.getElementById("datasetSelect").value
          );
          formData.append("x_col", document.getElementById("xCol").value);
          formData.append("y_col", document.getElementById("yCol").value);

          // 文本与 AI 分析部分
          formData.append("doc_text", document.getElementById("docText").value);

          document.getElementById("statusText").innerText = "正在分析，请稍候…";

          fetch("/analyze", {
            method: "POST",
            body: formData,
          })
            .then((res) => {
              if (!res.ok) {
                return res.json().then(data => {
                  throw new Error(data.msg || `HTTP ${res.status}`);
                });
              }
              return res.json();
            })
            .then((data) => {
              if (data.status === "error") {
                throw new Error(data.msg || "分析失败");
              }
              
              document.getElementById("statusText").innerText = "分析完成 ✓";
              document.getElementById("statusText").className = "small text-success";

              // 更新数值摘要
              document.getElementById("xyLabel").innerText =
                "(X 轴：" + data.x_col + "，Y 轴：" + data.y_col + ")";
              document.getElementById("summaryBox").innerText =
                data.summary || "未获得有效的统计摘要，请检查数据。";

              // 更新 AI 摘要
              document.getElementById("aiSummary").innerText =
                data.ai_summary ||
                "未输入金融文本，暂无法给出 AI 摘要示例。";

              // 更新情感条
              updateSentimentBar(data.sentiment || {});

              // 更新输出文件列表
              const files = data.files || [];
              const span = document.getElementById("savedFiles");
              if (files.length > 0) {
                span.innerHTML =
                  "分析结果文件已保存在后端，可通过以下链接下载：" +
                  files
                    .map((p) => {
                      const name = p.split(/[\\/]/).slice(-1)[0];
                      return (
                        '<a href="/files/' +
                        name +
                        '" target="_blank" class="me-2">' +
                        name +
                        "</a>"
                      );
                    })
                    .join("");
              } else {
                span.innerHTML = "";
              }

              // 更新五类图表
              updateCharts(data);
            })
            .catch((err) => {
              console.error(err);
              document.getElementById("statusText").innerText =
                "分析失败：" + err.message;
              document.getElementById("statusText").className = "small text-danger";
              
              // 显示错误提示
              alert("分析失败：" + err.message + "\n请检查数据格式或网络连接。");
            });
        });

      // 自适应窗口尺寸
      window.addEventListener("resize", function () {
        chartLine.resize();
        chartBar.resize();
        chartPie.resize();
        chartScatter.resize();
        chartBox.resize();
        wordChart.resize();
        predictChart.resize();
      });
    </script>
  </body>
</html>


